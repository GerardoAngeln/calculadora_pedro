<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SISTEMA PARA REPARACIÃ“N DE EQUIPOS</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f2f4f7;}
header{background:#0d6efd;color:#fff;padding:15px;text-align:center;font-size:18px;font-weight:bold;}
.container{padding:15px;}
.btn{width:100%;padding:16px;margin:6px 0;font-size:16px;border:none;border-radius:12px;background:#0d6efd;color:#fff;}
.btn.secondary{background:#6c757d;}
.btn.success{background:#198754;}
.btn.warn{background:#ffc107;color:#000;}
.card{background:#fff;border-radius:12px;padding:15px;margin-bottom:12px;}
input,textarea,select{width:100%;padding:12px;margin-top:8px;font-size:15px;border-radius:10px;border:1px solid #ccc;}
.hidden{display:none;}
.step{animation:fade .25s ease-in-out;}
@keyframes fade{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.kv{display:flex;justify-content:space-between;margin:6px 0;}
.badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:13px;color:#fff;}
.ok{background:#198754;}
.bad{background:#dc3545;}
.search{margin-bottom:10px;}
.tabs{display:flex;gap:5px;margin-bottom:10px;}
.tabs button{flex:1;}
</style>
</head>

<body>
<header>SISTEMA PARA REPARACIÃ“N DE EQUIPOS</header>

<div class="container">

<!-- INICIO -->
<div id="inicio" class="step">
  <button class="btn" onclick="mostrarPaso('cliente')">âž• Nueva ReparaciÃ³n</button>
  <button class="btn secondary" onclick="mostrarHistorial('pendiente')">ðŸ“‹ Pendientes</button>
  <button class="btn secondary" onclick="mostrarHistorial('entregado')">ðŸ“¦ Entregados</button>
  <button class="btn success" onclick="mostrarPaso('respaldo')">ðŸ’¾ Respaldo</button>
</div>

<!-- NUEVA -->
<div id="cliente" class="step hidden">
  <div class="card">
    <h3>ðŸ‘¤ Cliente</h3>
    <input id="clienteNombre" placeholder="Nombre">
    <input id="clienteTelefono" placeholder="TelÃ©fono">
    <button class="btn" onclick="mostrarPaso('equipo')">Siguiente</button>
    <button class="btn secondary" onclick="mostrarPaso('inicio')">Cancelar</button>
  </div>
</div>

<div id="equipo" class="step hidden">
  <div class="card">
    <h3>ðŸ“± Equipo</h3>
    <input id="marca" placeholder="Marca">
    <input id="modelo" placeholder="Modelo">
    <input id="color" placeholder="Color">
    <input id="imei" placeholder="IMEI">
    <button class="btn" onclick="mostrarPaso('falla')">Siguiente</button>
  </div>
</div>

<div id="falla" class="step hidden">
  <div class="card">
    <h3>ðŸ”§ Falla y Pago</h3>
    <textarea id="fallaTexto" placeholder="Describe la falla"></textarea>
    <input id="costo" placeholder="Costo total">
    <input id="anticipo" placeholder="Anticipo">
    <button class="btn" onclick="guardarReparacion()">Guardar ReparaciÃ³n</button>
  </div>
</div>

<!-- HISTORIAL -->
<div id="lista" class="step hidden">
  <input id="buscador" class="search" placeholder="ðŸ” Buscar..." oninput="filtrar()">
  <div id="listaItems"></div>
  <button class="btn secondary" onclick="mostrarPaso('inicio')">Volver</button>
</div>

<!-- DETALLE -->
<div id="detalle" class="step hidden"></div>

<!-- RESPALDO -->
<div id="respaldo" class="step hidden">
  <div class="card">
    <h3>ðŸ’¾ Respaldo de informaciÃ³n</h3>
    <button class="btn success" onclick="exportarDatos()">ðŸ“¤ Exportar respaldo</button>
    <input type="file" id="importFile" accept=".json" onchange="importarDatos()">
    <p style="font-size:13px;color:#555">
      Guarda el archivo en tu nube o envÃ­atelo por WhatsApp.
    </p>
    <button class="btn secondary" onclick="mostrarPaso('inicio')">Volver</button>
  </div>
</div>

</div>

<script>
const { jsPDF } = window.jspdf;
let cache=[], idx=null, modo="pendiente";

function mostrarPaso(id){
  document.querySelectorAll('.step').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function guardarReparacion(){
  let rep={
    folio:Date.now(),
    cliente:clienteNombre.value,
    telefono:clienteTelefono.value,
    marca:marca.value,
    modelo:modelo.value,
    color:color.value,
    imei:imei.value,
    falla:fallaTexto.value,
    costo:Number(costo.value||0),
    pagos:[{monto:Number(anticipo.value||0),fecha:new Date().toLocaleString()}],
    garantia:{aplica:false,dias:0,inicio:null,fin:null},
    estatus:"pendiente",
    fecha:new Date().toLocaleString(),
    fechaEntrega:null
  };
  let data=JSON.parse(localStorage.getItem("reparaciones")||"[]");
  data.push(rep);
  localStorage.setItem("reparaciones",JSON.stringify(data));
  mostrarPaso("inicio");
}

function mostrarHistorial(tipo){
  modo=tipo;
  mostrarPaso("lista");
  cache=JSON.parse(localStorage.getItem("reparaciones")||"[]")
    .filter(r=>r.estatus===tipo);
  renderLista(cache);
}

function renderLista(data){
  let c=document.getElementById("listaItems");
  if(!data.length){c.innerHTML="<div class='card'>Sin registros</div>";return;}
  c.innerHTML=data.map((r,i)=>{
    let pagado=r.pagos.reduce((s,p)=>s+p.monto,0);
    return `<div class="card" onclick="verDetalle(${i})">
      <strong>${r.cliente}</strong><br>
      ${r.marca} ${r.modelo}<br>
      ðŸ“ž ${r.telefono||"-"}<br>
      ðŸ’° Saldo: $${r.costo-pagado}
    </div>`;
  }).join("");
}

function filtrar(){
  let q=buscador.value.toLowerCase();
  let f=cache.filter(r=>
    r.cliente.toLowerCase().includes(q) ||
    r.telefono.toLowerCase().includes(q) ||
    r.modelo.toLowerCase().includes(q)
  );
  renderLista(f);
}

function verDetalle(i){
  idx=i;
  mostrarPaso("detalle");
  let d=cache[i];
  let pagado=d.pagos.reduce((s,p)=>s+p.monto,0);

  detalle.innerHTML=`
  <div class="card">
    <h3>ðŸ“„ Detalle</h3>
    <div class="kv"><span>Cliente</span><strong>${d.cliente}</strong></div>
    <div class="kv"><span>Equipo</span><strong>${d.marca} ${d.modelo}</strong></div>
    <div class="kv"><span>Costo</span><strong>$${d.costo}</strong></div>
    <div class="kv"><span>Pagado</span><strong>$${pagado}</strong></div>
    <div class="kv"><span>Saldo</span><strong>$${d.costo-pagado}</strong></div>
    <div class="kv"><span>Estatus</span><strong>${d.estatus}</strong></div>
  </div>

  ${d.estatus==="pendiente" ? `
    <select id="diasGar">
      <option value="0">Sin garantÃ­a</option>
      <option value="15">15 dÃ­as</option>
      <option value="30">30 dÃ­as</option>
      <option value="60">60 dÃ­as</option>
    </select>
    <button class="btn warn" onclick="entregarEquipo()">ðŸ“¦ Entregar equipo</button>
  ` : ""}

  <button class="btn success" onclick="generarPDF()">ðŸ§¾ Comprobante</button>
  <button class="btn secondary" onclick="mostrarHistorial(modo)">Volver</button>
  `;
}

function entregarEquipo(){
  let data=JSON.parse(localStorage.getItem("reparaciones"));
  let original=data.find(r=>r.folio===cache[idx].folio);
  original.estatus="entregado";
  original.fechaEntrega=new Date().toLocaleString();

  let dias=Number(document.getElementById("diasGar").value||0);
  if(dias>0){
    let ini=new Date(), fin=new Date();
    fin.setDate(ini.getDate()+dias);
    original.garantia={aplica:true,dias,inicio:ini.toISOString(),fin:fin.toISOString()};
  }

  localStorage.setItem("reparaciones",JSON.stringify(data));
  mostrarHistorial("pendiente");
}

function generarPDF(){
  let d=cache[idx];
  let pagado=d.pagos.reduce((s,p)=>s+p.monto,0);
  let pdf=new jsPDF();
  pdf.setFontSize(14);
  pdf.text("COMPROBANTE DE REPARACIÃ“N",20,20);
  pdf.setFontSize(11);
  pdf.text(`Folio: ${d.folio}`,20,35);
  pdf.text(`Cliente: ${d.cliente}`,20,45);
  pdf.text(`Equipo: ${d.marca} ${d.modelo}`,20,55);
  pdf.text(`Costo: $${d.costo}`,20,70);
  pdf.text(`Pagado: $${pagado}`,20,80);
  pdf.text(`Saldo: $${d.costo-pagado}`,20,90);
  pdf.open();
}

/* RESPALDO */
function exportarDatos(){
  let data=localStorage.getItem("reparaciones")||"[]";
  let blob=new Blob([data],{type:"application/json"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="respaldo_reparaciones.json";
  a.click();
}

function importarDatos(){
  let file=document.getElementById("importFile").files[0];
  if(!file) return;
  let reader=new FileReader();
  reader.onload=e=>{
    localStorage.setItem("reparaciones",e.target.result);
    alert("Respaldo restaurado correctamente");
    mostrarPaso("inicio");
  };
  reader.readAsText(file);
}
</script>

</body>
</html>
