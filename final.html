<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de ReparaciÃ³n de Equipos</title>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f2f4f7;}
header{background:#0d6efd;color:#fff;padding:15px;text-align:center;font-size:18px;font-weight:bold;}
.container{padding:15px;}
.btn{width:100%;padding:14px;margin:6px 0;font-size:16px;border:none;border-radius:12px;background:#0d6efd;color:#fff;}
.btn.secondary{background:#6c757d;}
.btn.success{background:#198754;}
.btn.warn{background:#ffc107;color:#000;}
.btn.danger{background:#dc3545;}
.card{background:#fff;border-radius:12px;padding:15px;margin-bottom:12px;}
input,textarea,select{width:100%;padding:10px;margin-top:8px;font-size:15px;border-radius:10px;border:1px solid #ccc;}
.hidden{display:none;}
.step{animation:fade .2s ease-in-out;}
@keyframes fade{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
textarea.texto{height:300px;font-family:monospace;}
.badge{padding:4px 10px;border-radius:12px;font-size:12px;color:#fff;display:inline-block;}
.ok{background:#198754;}
.bad{background:#dc3545;}
.none{background:#6c757d;}
.search{margin-bottom:10px;}
</style>
</head>

<body>
<header>SISTEMA PARA REPARACIÃ“N DE EQUIPOS</header>

<div class="container">

<div id="inicio" class="step">
  <button class="btn" onclick="mostrarPaso('cliente')">â• Nueva ReparaciÃ³n</button>
  <button class="btn secondary" onclick="mostrarPendientes()">ğŸ“‹ Pendientes</button>
  <button class="btn secondary" onclick="mostrarEntregados()">ğŸ“¦ Entregados</button>
  <button class="btn success" onclick="mostrarPaso('respaldo')">ğŸ’¾ Respaldo</button>
</div>

<div id="cliente" class="step hidden">
  <div class="card">
    <h3>ğŸ‘¤ Cliente</h3>
    <input id="clienteNombre" placeholder="Nombre del cliente">
    <input id="clienteTelefono" placeholder="TelÃ©fono WhatsApp (10 dÃ­gitos)">
    <button class="btn" onclick="mostrarPaso('equipo')">Siguiente</button>
  </div>
</div>

<div id="equipo" class="step hidden">
  <div class="card">
    <h3>ğŸ“± Equipo</h3>
    <input id="marca" placeholder="Marca">
    <input id="modelo" placeholder="Modelo">
    <input id="color" placeholder="Color">
    <input id="imei" placeholder="IMEI (opcional)">
    <button class="btn" onclick="mostrarPaso('falla')">Siguiente</button>
  </div>
</div>

<div id="falla" class="step hidden">
  <div class="card">
    <h3>ğŸ”§ Falla y Pago</h3>
    <textarea id="fallaTexto" placeholder="Describe la falla"></textarea>
    <input id="costo" placeholder="Costo total">
    <input id="anticipo" placeholder="Anticipo">
    <button class="btn success" onclick="guardarReparacion()">Guardar reparaciÃ³n</button>
  </div>
</div>

<div id="comprobante" class="step hidden">
  <div class="card">
    <h3>ğŸ“„ Comprobante</h3>
    <textarea id="textoComprobante" class="texto" readonly></textarea>
    <button class="btn success" onclick="confirmarEnvio()">ğŸ“© Enviar por WhatsApp</button>
    <button class="btn secondary" onclick="mostrarPaso('inicio')">Finalizar</button>
  </div>
</div>

<div id="lista" class="step hidden">
  <input id="buscador" class="search" placeholder="ğŸ” Buscar por cliente o folio" oninput="filtrar()">
  <div id="listaItems"></div>
  <button class="btn secondary" onclick="mostrarPaso('inicio')">Volver</button>
</div>

<div id="detalle" class="step hidden"></div>

<div id="respaldo" class="step hidden">
  <div class="card">
    <h3>ğŸ’¾ Respaldo</h3>
    <button class="btn success" onclick="exportarDatos()">ğŸ“¤ Exportar respaldo</button>
    <input type="file" id="importFile" accept=".json" onchange="importarDatos()">
    <button class="btn secondary" onclick="mostrarPaso('inicio')">Volver</button>
  </div>
</div>

</div>

<script>
let cache=[], idx=null, textoActual="", modo="pendiente", ordenActual=null;

/* ===== FOLIO SEGURO ===== */
function obtenerFolio(){
  let f=parseInt(localStorage.getItem("folioActual"),10);
  if(isNaN(f)||f<1) f=1;
  localStorage.setItem("folioActual",f+1);
  return String(f).padStart(3,"0");
}

/* ===== UTIL ===== */
function mostrarPaso(id){
  document.querySelectorAll('.step').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
function fechaHora(){return new Date().toLocaleString();}

/* ===== WHATSAPP ===== */
function normalizarTelefono(t){
  let n=t.replace(/\D/g,'');
  if(n.length===10) n="52"+n;
  return n;
}
function confirmarEnvio(){
  if(!ordenActual) return;
  if(confirm("Â¿Enviar comprobante por WhatsApp?")){
    window.open("https://wa.me/"+ordenActual.telefono+"?text="+encodeURIComponent(textoActual),"_blank");
  }
}

/* ===== TEXTOS ===== */
function textoRecepcion(r){
return `ğŸ“„ RECEPCIÃ“N DE EQUIPO

ğŸ†” Folio: ${r.folio}
â° Fecha: ${r.fecha}

ğŸ‘¤ Cliente: ${r.cliente}
ğŸ“ TelÃ©fono: ${r.telefono}

ğŸ“± Equipo: ${r.marca} ${r.modelo}
ğŸ¨ Color: ${r.color}
ğŸ”¢ IMEI: ${r.imei}

ğŸ”§ Falla:
${r.falla}

ğŸ’° Costo: $${r.costo}
ğŸ’µ Anticipo: $${r.anticipo}
ğŸ’² Saldo: $${r.costo-r.anticipo}
`;
}

function textoEntrega(r){
let g=r.garantia;
return textoRecepcion(r)+`
ğŸ“¦ ENTREGA DE EQUIPO
â° Fecha entrega: ${r.fechaEntrega}

ğŸ›¡ï¸ GarantÃ­a:
${g?`${g.dias} dÃ­as (vence ${new Date(g.fin).toLocaleDateString()})`:"Sin garantÃ­a"}

Gracias por su preferencia.`;
}

/* ===== GUARDAR ===== */
function guardarReparacion(){
let rep={
folio:obtenerFolio(),
fecha:fechaHora(),
cliente:clienteNombre.value,
telefono:normalizarTelefono(clienteTelefono.value),
marca:marca.value,
modelo:modelo.value,
color:color.value,
imei:imei.value||"No proporcionado",
falla:fallaTexto.value,
costo:Number(costo.value||0),
anticipo:Number(anticipo.value||0),
estatus:"pendiente",
garantia:null,
fechaEntrega:null
};
let d=JSON.parse(localStorage.getItem("reparaciones")||"[]");
d.push(rep);
localStorage.setItem("reparaciones",JSON.stringify(d));
ordenActual=rep;
textoActual=textoRecepcion(rep);
textoComprobante.value=textoActual;
mostrarPaso("comprobante");
}

/* ===== LISTAS ===== */
function mostrarPendientes(){modo="pendiente";cargarLista("pendiente");}
function mostrarEntregados(){modo="entregado";cargarLista("entregado");}

function cargarLista(t){
mostrarPaso("lista");
let all=JSON.parse(localStorage.getItem("reparaciones")||"[]");
cache=all.map((r,i)=>({...r,_i:i})).filter(r=>r.estatus===t);
renderLista();
}

function renderLista(){
listaItems.innerHTML=cache.length?cache.map((r,i)=>`
<div class="card" onclick="verDetalle(${i})">
<strong>${r.cliente}</strong><br>
${r.marca} ${r.modelo}<br>
Folio: ${r.folio}
</div>`).join(""):"<div class='card'>Sin registros</div>";
}

function filtrar(){
let q=buscador.value.toLowerCase();
renderLista(cache.filter(r=>r.cliente.toLowerCase().includes(q)||r.folio.includes(q)));
}

/* ===== DETALLE ===== */
function verDetalle(i){
idx=i;
let r=cache[i];
ordenActual=r;
mostrarPaso("detalle");
detalle.innerHTML=`
<div class="card">
<input id="eCliente" value="${r.cliente}">
<input id="eTelefono" value="${r.telefono}">
<input id="eMarca" value="${r.marca}">
<input id="eModelo" value="${r.modelo}">
<textarea id="eFalla">${r.falla}</textarea>
<input id="eCosto" value="${r.costo}">
<input id="eAnticipo" value="${r.anticipo}">
</div>
${r.estatus==="pendiente"?`
<select id="diasGar">
<option value="0">Sin garantÃ­a</option>
<option value="15">15 dÃ­as</option>
<option value="30">30 dÃ­as</option>
<option value="60">60 dÃ­as</option>
</select>
<button class="btn warn" onclick="entregarEquipo()">ğŸ“¦ Entregar</button>`:""}
<button class="btn success" onclick="guardarEdicion()">ğŸ’¾ Guardar cambios</button>
<button class="btn danger" onclick="eliminarOrden()">ğŸ—‘ï¸ Eliminar</button>
<button class="btn secondary" onclick="mostrarPaso('inicio')">Volver</button>`;
}

function guardarEdicion(){
let d=JSON.parse(localStorage.getItem("reparaciones"));
let r=d[cache[idx]._i];
r.cliente=eCliente.value;
r.telefono=normalizarTelefono(eTelefono.value);
r.marca=eMarca.value;
r.modelo=eModelo.value;
r.falla=eFalla.value;
r.costo=Number(eCosto.value||0);
r.anticipo=Number(eAnticipo.value||0);
localStorage.setItem("reparaciones",JSON.stringify(d));
alert("Actualizado");
mostrarPaso("inicio");
}

function eliminarOrden(){
if(!confirm("Â¿Eliminar definitivamente?"))return;
let d=JSON.parse(localStorage.getItem("reparaciones"));
d.splice(cache[idx]._i,1);
localStorage.setItem("reparaciones",JSON.stringify(d));
alert("Eliminada");
mostrarPaso("inicio");
}

/* ===== ENTREGA ===== */
function entregarEquipo(){
let d=JSON.parse(localStorage.getItem("reparaciones"));
let r=d[cache[idx]._i];
let dias=Number(diasGar.value);
if(dias>0){
let ini=new Date(),fin=new Date();
fin.setDate(ini.getDate()+dias);
r.garantia={dias,inicio:ini.toISOString(),fin:fin.toISOString()};
}
r.estatus="entregado";
r.fechaEntrega=fechaHora();
localStorage.setItem("reparaciones",JSON.stringify(d));
ordenActual=r;
textoActual=textoEntrega(r);
textoComprobante.value=textoActual;
mostrarPaso("comprobante");
}

/* ===== RESPALDO ===== */
function exportarDatos(){
let d=localStorage.getItem("reparaciones")||"[]";
let b=new Blob([d],{type:"application/json"});
let a=document.createElement("a");
a.href=URL.createObjectURL(b);
a.download="respaldo_reparaciones.json";
a.click();
}
function importarDatos(){
let f=importFile.files[0];
if(!f)return;
let r=new FileReader();
r.onload=e=>{
localStorage.setItem("reparaciones",e.target.result);
alert("Restaurado");
mostrarPaso("inicio");
};
r.readAsText(f);
}
</script>
</body>
</html>
