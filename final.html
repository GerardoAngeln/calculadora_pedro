<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SISTEMA PARA REPARACIÃ“N DE EQUIPOS</title>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f2f4f7;}
header{background:#0d6efd;color:#fff;padding:15px;text-align:center;font-size:18px;font-weight:bold;}
.container{padding:15px;}
.btn{width:100%;padding:16px;margin:6px 0;font-size:16px;border:none;border-radius:12px;background:#0d6efd;color:#fff;}
.btn.secondary{background:#6c757d;}
.btn.success{background:#198754;}
.btn.warn{background:#ffc107;color:#000;}
.card{background:#fff;border-radius:12px;padding:15px;margin-bottom:12px;}
input,textarea,select{width:100%;padding:12px;margin-top:8px;font-size:15px;border-radius:10px;border:1px solid #ccc;}
.hidden{display:none;}
.step{animation:fade .25s ease-in-out;}
@keyframes fade{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
textarea.texto{height:280px;font-family:monospace;}
</style>
</head>

<body>
<header>SISTEMA PARA REPARACIÃ“N DE EQUIPOS</header>

<div class="container">

<!-- INICIO -->
<div id="inicio" class="step">
  <button class="btn" onclick="mostrarPaso('cliente')">âž• Nueva ReparaciÃ³n</button>
  <button class="btn secondary" onclick="mostrarPendientes()">ðŸ“‹ Pendientes</button>
  <button class="btn secondary" onclick="mostrarEntregados()">ðŸ“¦ Entregados</button>
  <button class="btn success" onclick="mostrarPaso('respaldo')">ðŸ’¾ Respaldo</button>
</div>

<!-- CLIENTE -->
<div id="cliente" class="step hidden">
  <div class="card">
    <h3>ðŸ‘¤ Cliente</h3>
    <input id="clienteNombre" placeholder="Nombre">
    <input id="clienteTelefono" placeholder="TelÃ©fono / WhatsApp">
    <button class="btn" onclick="mostrarPaso('equipo')">Siguiente</button>
  </div>
</div>

<!-- EQUIPO -->
<div id="equipo" class="step hidden">
  <div class="card">
    <h3>ðŸ“± Equipo</h3>
    <input id="marca" placeholder="Marca">
    <input id="modelo" placeholder="Modelo">
    <input id="color" placeholder="Color">
    <input id="imei" placeholder="IMEI (opcional)">
    <button class="btn" onclick="mostrarPaso('falla')">Siguiente</button>
  </div>
</div>

<!-- FALLA -->
<div id="falla" class="step hidden">
  <div class="card">
    <h3>ðŸ”§ Falla y Pago</h3>
    <textarea id="fallaTexto" placeholder="Describe la falla"></textarea>
    <input id="costo" placeholder="Costo total">
    <input id="anticipo" placeholder="Anticipo">
    <button class="btn success" onclick="guardarReparacion()">Guardar reparaciÃ³n</button>
  </div>
</div>

<!-- TEXTO -->
<div id="comprobante" class="step hidden">
  <div class="card">
    <h3>ðŸ“„ Texto generado</h3>
    <textarea id="textoComprobante" class="texto" readonly></textarea>
    <button class="btn success" onclick="enviarWhatsApp()">ðŸ“© Enviar por WhatsApp</button>
    <button class="btn secondary" onclick="mostrarPaso('inicio')">Finalizar</button>
  </div>
</div>

<!-- LISTA -->
<div id="lista" class="step hidden">
  <div id="listaItems"></div>
  <button class="btn secondary" onclick="mostrarPaso('inicio')">Volver</button>
</div>

<!-- DETALLE -->
<div id="detalle" class="step hidden"></div>

<!-- RESPALDO -->
<div id="respaldo" class="step hidden">
  <div class="card">
    <h3>ðŸ’¾ Respaldo</h3>
    <button class="btn success" onclick="exportarDatos()">ðŸ“¤ Exportar respaldo</button>
    <input type="file" id="importFile" accept=".json" onchange="importarDatos()">
    <button class="btn secondary" onclick="mostrarPaso('inicio')">Volver</button>
  </div>
</div>

</div>

<script>
let cache=[], idx=null, textoActual="";

/* FOLIO DESDE 001 */
function obtenerFolio(){
  let f = Number(localStorage.getItem("folioActual") || 1);
  localStorage.setItem("folioActual", f + 1);
  return String(f).padStart(3,"0");
}

function mostrarPaso(id){
  document.querySelectorAll('.step').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function fechaHora(){ return new Date().toLocaleString(); }

/* RECEPCIÃ“N */
function guardarReparacion(){
  let rep={
    folio: obtenerFolio(),
    fecha: fechaHora(),
    cliente: clienteNombre.value,
    telefono: clienteTelefono.value,
    marca: marca.value,
    modelo: modelo.value,
    color: color.value,
    imei: imei.value || "No proporcionado",
    falla: fallaTexto.value,
    costo: Number(costo.value||0),
    anticipo: Number(anticipo.value||0),
    estatus:"pendiente",
    garantia:null
  };

  let data=JSON.parse(localStorage.getItem("reparaciones")||"[]");
  data.push(rep);
  localStorage.setItem("reparaciones",JSON.stringify(data));

  textoActual = generarTextoRecepcion(rep);
  textoComprobante.value = textoActual;
  mostrarPaso("comprobante");
}

function generarTextoRecepcion(r){
  return `ðŸ“„ RECEPCIÃ“N DE EQUIPO

ðŸ†” Folio: ${r.folio}
â° Fecha: ${r.fecha}

ðŸ‘¤ Cliente: ${r.cliente}
ðŸ“ž TelÃ©fono: ${r.telefono}

ðŸ“± Equipo: ${r.marca} ${r.modelo}
ðŸŽ¨ Color: ${r.color}
ðŸ”¢ IMEI: ${r.imei}

ðŸ”§ Falla:
${r.falla}

ðŸ’° Costo: $${r.costo}
ðŸ’µ Anticipo: $${r.anticipo}
ðŸ’² Saldo: $${r.costo - r.anticipo}
`;
}

/* LISTAS */
function mostrarPendientes(){
  mostrarPaso("lista");
  let all=JSON.parse(localStorage.getItem("reparaciones")||"[]");
  cache=all.map((r,i)=>({...r,_i:i})).filter(r=>r.estatus==="pendiente");
  renderLista();
}

function mostrarEntregados(){
  mostrarPaso("lista");
  let all=JSON.parse(localStorage.getItem("reparaciones")||"[]");
  cache=all.map((r,i)=>({...r,_i:i})).filter(r=>r.estatus==="entregado");
  renderLista();
}

function renderLista(){
  listaItems.innerHTML = cache.map((r,i)=>`
    <div class="card" onclick="verDetalle(${i})">
      <strong>${r.cliente}</strong><br>
      ${r.marca} ${r.modelo}<br>
      Folio: ${r.folio}
    </div>
  `).join("") || "<div class='card'>Sin registros</div>";
}

/* DETALLE + ENTREGA */
function verDetalle(i){
  idx=i;
  let r=cache[i];
  mostrarPaso("detalle");

  detalle.innerHTML=`
    <div class="card">
      <strong>${r.cliente}</strong><br>
      ${r.marca} ${r.modelo}<br>
      Estatus: ${r.estatus}
    </div>

    ${r.estatus==="pendiente"?`
      <select id="diasGar">
        <option value="0">Sin garantÃ­a</option>
        <option value="15">15 dÃ­as</option>
        <option value="30">30 dÃ­as</option>
        <option value="60">60 dÃ­as</option>
      </select>
      <button class="btn warn" onclick="entregarEquipo()">ðŸ“¦ Entregar</button>
    `:""}

    <button class="btn secondary" onclick="mostrarPaso('inicio')">Volver</button>
  `;
}

function entregarEquipo(){
  let data=JSON.parse(localStorage.getItem("reparaciones"));
  let real=data[cache[idx]._i];
  let dias=Number(document.getElementById("diasGar").value);

  let ini=new Date();
  let fin=null;

  if(dias>0){
    fin=new Date();
    fin.setDate(ini.getDate()+dias);
    real.garantia={dias,inicio:ini.toISOString(),fin:fin.toISOString()};
  }

  real.estatus="entregado";
  localStorage.setItem("reparaciones",JSON.stringify(data));

  textoActual =
    generarTextoRecepcion(real) +
    `\nðŸ“¦ ENTREGA DE EQUIPO
â° Fecha de entrega: ${fechaHora()}
ðŸ›¡ï¸ GarantÃ­a: ${dias>0 ? dias+" dÃ­as (vence "+fin.toLocaleDateString()+")" : "No aplica"}

Gracias por su preferencia.`;

  textoComprobante.value = textoActual;
  mostrarPaso("comprobante");
}

function enviarWhatsApp(){
  window.open("https://wa.me/?text="+encodeURIComponent(textoActual),"_blank");
}

/* RESPALDO */
function exportarDatos(){
  let data=localStorage.getItem("reparaciones")||"[]";
  let blob=new Blob([data],{type:"application/json"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="respaldo_reparaciones.json";
  a.click();
}

function importarDatos(){
  let f=document.getElementById("importFile").files[0];
  if(!f)return;
  let r=new FileReader();
  r.onload=e=>{
    localStorage.setItem("reparaciones",e.target.result);
    alert("Respaldo restaurado");
    mostrarPaso("inicio");
  };
  r.readAsText(f);
}
</script>

</body>
</html>
