<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cobranza MÃ³vil</title>

<style>
body{margin:0;font-family:'Segoe UI',Arial,sans-serif;background:#f3f4f6}
.view{display:none}
header{background:#2ecc71;color:#fff;padding:16px;text-align:center;font-weight:600}
.box{background:#fff;margin:16px;padding:16px;border-radius:14px}
.btn{width:100%;padding:14px;margin:8px 0;border:none;border-radius:10px;font-size:16px}
.admin{background:#111827;color:#fff}
.cobrador{background:#2ecc71;color:#fff}
.volver{background:#d1d5db}
input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd}
.item{background:#f1f5f9;padding:12px;border-radius:10px;margin-bottom:8px;cursor:pointer}
.small{font-size:13px;color:#555}
canvas{width:100%;border:1px solid #ddd;border-radius:10px;margin-top:10px}
</style>
</head>

<body>

<!-- INICIO -->
<div id="inicioView" class="view">
  <div class="box" style="text-align:center">
    <h2>Cobranza MÃ³vil</h2>
    <p>ðŸ’¼ Promociones Culturales</p>
    <button class="btn admin" onclick="show('adminView')">ADMIN</button>
    <button class="btn cobrador" onclick="entrarCobrador()">COBRADOR</button>
  </div>
</div>

<!-- ADMIN -->
<div id="adminView" class="view">
<header>Administrador</header>

<div class="box">
<h4>Alta de Clientes</h4>
<input id="cNombre" placeholder="Nombre">
<input id="cTel" placeholder="TelÃ©fono">
<button class="btn cobrador" onclick="addCliente()">Guardar cliente</button>
</div>

<div class="box">
<h4>Alta de Cobradores</h4>
<input id="coNombre" placeholder="Nombre">
<button class="btn admin" onclick="addCobrador()">Guardar cobrador</button>
</div>

<div class="box">
<h4>Asignar Cliente a Cobrador</h4>
<select id="asCliente"></select>
<select id="asCobrador"></select>
<button class="btn cobrador" onclick="asignarCliente()">Asignar</button>
</div>

<div class="box">
<h4>Registrar Venta</h4>
<select id="vCliente"></select>
<input id="vConcepto" placeholder="Concepto">
<input type="number" id="vTotal" placeholder="Total">
<input type="number" id="vAbono" placeholder="Abono inicial (opcional)">
<button class="btn cobrador" onclick="registrarVenta()">Registrar venta</button>
</div>

<div class="box">
<h4>Comprobante de Venta</h4>
<canvas id="canvasVenta" width="320" height="420"></canvas>
<button class="btn admin" onclick="descargarComprobante()">Descargar comprobante</button>
</div>

<button class="btn volver" onclick="show('inicioView')">Volver</button>
</div>

<!-- RUTA COBRADOR -->
<div id="rutaView" class="view">
<header>Clientes asignados</header>
<div class="box" id="listaClientes"></div>
<button class="btn volver" onclick="show('inicioView')">Salir</button>
</div>

<!-- CLIENTE -->
<div id="clienteView" class="view">
<header id="clienteHeader"></header>
<div class="box" id="ventasCliente"></div>
<button class="btn volver" onclick="volverRuta()">Volver</button>
</div>

<!-- COBRO -->
<div id="cobroView" class="view">
<header>Cobro / Comprobante</header>

<div class="box">
<div id="infoVenta" class="small"></div>
<input type="number" id="montoCobro" placeholder="Monto a cobrar">
<button class="btn cobrador" onclick="registrarCobro()">Registrar cobro</button>
</div>

<div class="box">
<canvas id="canvasPago" width="320" height="420"></canvas>
<button class="btn admin" onclick="descargarComprobante()">Descargar comprobante</button>
</div>

<button class="btn volver" onclick="volverCliente()">Volver</button>
</div>

<script>
/* INICIO */
show('inicioView');

/* DATA */
let clientes=[], cobradores=[], ventas=[], abonos=[];
let cobradorActivo=null, clienteActual=null, ventaActual=null;
let tipoComprobante="";

/* NAV */
function show(id){
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  document.getElementById(id).style.display='block';
}

/* ADMIN */
function addCliente(){
  clientes.push({id:Date.now(),nombre:cNombre.value,telefono:cTel.value,cobrador:null});
  cNombre.value=cTel.value="";
  renderAdmin();
}
function addCobrador(){
  cobradores.push({id:Date.now(),nombre:coNombre.value});
  coNombre.value="";
  renderAdmin();
}
function asignarCliente(){
  clientes.find(c=>c.id==asCliente.value).cobrador=asCobrador.value;
  alert("Cliente asignado");
}
function registrarVenta(){
  let total=+vTotal.value, abono=+vAbono.value||0;
  ventaActual={
    id:Date.now(),
    cliente:vCliente.value,
    concepto:vConcepto.value,
    total,
    saldo:total-abono
  };
  ventas.push(ventaActual);
  generarComprobanteVenta();
  alert("Venta registrada");
}
function renderAdmin(){
  asCliente.innerHTML=vCliente.innerHTML=clientes.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join("");
  asCobrador.innerHTML=cobradores.map(c=>`<option value="${c.id}">${c.nombre}</option>`).join("");
}

/* COBRADOR */
function entrarCobrador(){
  cobradorActivo=cobradores[0]?.id||null;
  show('rutaView');renderRuta();
}
function renderRuta(){
  listaClientes.innerHTML=clientes.filter(c=>c.cobrador==cobradorActivo).map(c=>{
    let saldo=ventas.filter(v=>v.cliente==c.id).reduce((s,v)=>s+v.saldo,0);
    return `<div class="item" onclick="abrirCliente(${c.id})">
      <strong>${c.nombre}</strong><br>Saldo: $${saldo}
    </div>`;
  }).join("") || "Sin clientes asignados";
}
function abrirCliente(id){
  clienteActual=clientes.find(c=>c.id===id);
  clienteHeader.innerText=clienteActual.nombre;
  ventasCliente.innerHTML=ventas.filter(v=>v.cliente==id).map(v=>`
    <div class="item" onclick="abrirVenta(${v.id})">
      ${v.concepto} â€“ $${v.saldo}
    </div>`).join("");
  show('clienteView');
}
function abrirVenta(id){
  ventaActual=ventas.find(v=>v.id===id);
  infoVenta.innerText=ventaActual.concepto+" | Saldo: $"+ventaActual.saldo;
  generarComprobanteVenta();
  show('cobroView');
}
function registrarCobro(){
  let monto=+montoCobro.value;
  if(!monto||monto>ventaActual.saldo){alert("Monto invÃ¡lido");return;}
  ventaActual.saldo-=monto;
  abonos.push({venta:ventaActual.id,monto,fecha:new Date().toLocaleString()});
  generarComprobantePago(monto);
}

/* COMPROBANTES */
function generarComprobanteVenta(){
  tipoComprobante="venta";
  const c=document.getElementById("canvasVenta");
  const ctx=c.getContext("2d");
  ctx.fillStyle="#fff";ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle="#000";ctx.font="18px Arial";
  ctx.fillText("COMPROBANTE DE VENTA",40,30);
  ctx.font="14px Arial";
  ctx.fillText("Cobranza MÃ³vil",20,70);
  ctx.fillText("Promociones Culturales",20,90);
  ctx.fillText("Concepto: "+ventaActual.concepto,20,130);
  ctx.fillText("Total: $"+ventaActual.total,20,160);
  ctx.fillText("Saldo: $"+ventaActual.saldo,20,190);
  ctx.fillText("Fecha: "+new Date().toLocaleString(),20,230);
}

function generarComprobantePago(monto){
  tipoComprobante="pago";
  const c=document.getElementById("canvasPago");
  const ctx=c.getContext("2d");
  ctx.fillStyle="#fff";ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle="#000";ctx.font="18px Arial";
  ctx.fillText("COMPROBANTE DE PAGO",40,30);
  ctx.font="14px Arial";
  ctx.fillText("Cliente: "+clienteActual.nombre,20,80);
  ctx.fillText("Concepto: "+ventaActual.concepto,20,110);
  ctx.fillText("Monto pagado: $"+monto,20,140);
  ctx.fillText("Saldo restante: $"+ventaActual.saldo,20,170);
  ctx.fillText("Fecha: "+new Date().toLocaleString(),20,210);
}

/* DESCARGA */
function descargarComprobante(){
  const canvas = tipoComprobante==="venta" ? canvasVenta : canvasPago;
  const fecha=new Date().toISOString().slice(0,10);
  const nombre=(clienteActual?.nombre||"cliente").replace(/\s+/g,'_').toLowerCase();
  const link=document.createElement("a");
  link.download=`${tipoComprobante}_${nombre}_${fecha}.png`;
  link.href=canvas.toDataURL("image/png");
  link.click();
}

/* VOLVER */
function volverRuta(){show('rutaView');renderRuta();}
function volverCliente(){show('clienteView');}
</script>

</body>
</html>
