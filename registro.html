<script type="module">
/* ===============================
   üî• FIREBASE IMPORTS
================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* ===============================
   üîß FIREBASE CONFIG (TUYO)
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyD1ut8X7XBvB2i0586jjmDMlD1c4cDCk",
  authDomain: "registrospersonal-c63f1.firebaseapp.com",
  projectId: "registrospersonal-c63f1",
  storageBucket: "registrospersonal-c63f1.firebasestorage.app",
  messagingSenderId: "480338151670",
  appId: "1:480338151670:web:213d61fd5ac4cfd3c844d7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colRef = collection(db, "colaboradores");

console.log("üî• Firebase conectado");

/* ===============================
   üïí FECHA Y HORA
================================ */
function actualizarFechaHora(){
  const n=new Date();
  const f=n.toLocaleDateString('es-MX',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  let h=n.getHours(),m=n.getMinutes().toString().padStart(2,'0'),a=h>=12?'PM':'AM';
  h=h%12||12;
  datetime.innerHTML=`<div class="date">${f}</div><div class="time">${h}:${m} ${a}</div>`;
}
setInterval(actualizarFechaHora,1000);actualizarFechaHora();

/* ===============================
   üß† UTILIDADES
================================ */
const hash=t=>btoa(t);
let cacheCols=[]; // respaldo local
let actualIndex=null;

/* ===============================
   üîÑ CARGAR COLABORADORES
================================ */
async function cargarDesdeFirebase(){
  const snap = await getDocs(colRef);
  cacheCols = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  localStorage.setItem("colaboradores", JSON.stringify(cacheCols));
}
await cargarDesdeFirebase();

/* ===============================
   üß≠ NAVEGACI√ìN (IGUAL)
================================ */
function ocultar(){document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'))}
window.volverInicio=()=>{ocultar();inicio.classList.remove('hidden')}
window.volverPanelAdmin=()=>{ocultar();panelAdmin.classList.remove('hidden')}
window.volverPanelCol=()=>{ocultar();panelCol.classList.remove('hidden')}

/* ===============================
   üë®‚Äçüíº ADMIN
================================ */
window.abrirAdmin=()=>{ocultar();loginAdmin.classList.remove('hidden')}
window.validarAdmin=()=>{
  adminPass.value==='1234'
  ? (ocultar(),panelAdmin.classList.remove('hidden'))
  : alert('Contrase√±a incorrecta')
}
window.mostrarAlta=()=>{ocultar();altaCol.classList.remove('hidden')}

window.guardarColaborador=async ()=>{
  const nuevo = {
    numero: cacheCols.length+1,
    nombre: colNombre.value,
    password: hash(colPassNew.value),
    zona: colZona.value,
    estatus: colEstatus.value,
    fechaAlta: new Date().toLocaleDateString(),
    beneficiarios:[]
  };
  await addDoc(colRef,nuevo);
  await cargarDesdeFirebase();
  alert("Colaborador guardado en Firebase");
  volverPanelAdmin();
}

window.mostrarLista=()=>{
  ocultar();listaCol.classList.remove('hidden');
  lista.innerHTML='';
  cacheCols.forEach(c=>{
    lista.innerHTML+=`
      <div class="list">
        <b>${c.numero} - ${c.nombre}</b><br>
        <span class="small">${c.zona} | ${c.estatus}</span>
      </div>`;
  });
}

window.mostrarReporte=()=>{
  ocultar();reporte.classList.remove('hidden');
  filtroCol.innerHTML='<option value="">Selecciona colaborador</option>';
  cacheCols.forEach((c,i)=>{
    filtroCol.innerHTML+=`<option value="${i}">${c.numero} - ${c.nombre}</option>`;
  });
  tablaReporte.innerHTML='';
}

window.cargarReporte=()=>{
  const i=filtroCol.value;
  if(i===''){tablaReporte.innerHTML='';return;}
  const c=cacheCols[i];
  let h='';
  c.beneficiarios.forEach(b=>{
    h+=`
      <div class="list">
        <b>${b.nombre}</b><br>
        <span class="small">${b.telefono} | ${b.correo}</span>
      </div>`;
  });
  tablaReporte.innerHTML=h||'<p class="small">Sin beneficiarios</p>';
}

/* ===============================
   üë§ COLABORADOR
================================ */
window.abrirColaborador=()=>{
  ocultar();loginCol.classList.remove('hidden');
  selectCol.innerHTML='';
  cacheCols.forEach((c,i)=>{
    selectCol.innerHTML+=`<option value="${i}">${c.numero} - ${c.nombre}</option>`;
  });
}

window.validarColaborador=()=>{
  const i=selectCol.value;
  const c=cacheCols[i];
  if(!c || c.password!==hash(colPass.value)){
    alert("Contrase√±a incorrecta");return;
  }
  actualIndex=i;
  ocultar();panelCol.classList.remove('hidden');
  infoCol.innerHTML=`
    <b>${c.nombre}</b><br>
    Zona: ${c.zona}<br>
    Estatus: ${c.estatus}<br>
    Fecha alta: ${c.fechaAlta}
  `;
}

window.mostrarBenefCol=()=>{
  ocultar();benefCol.classList.remove('hidden');
  listarBenefCol();
}

async function listarBenefCol(){
  listaBen.innerHTML='';
  cacheCols[actualIndex].beneficiarios.forEach((b,i)=>{
    listaBen.innerHTML+=`
      <div class="list">
        <b>${b.nombre}</b><br>
        <span class="small">${b.telefono}</span>
        <button onclick="eliminarBenef(${i})">Eliminar</button>
      </div>`;
  });
}

window.guardarBenefCol=async ()=>{
  const c=cacheCols[actualIndex];
  c.beneficiarios.push({
    nombre:bNombre.value,
    telefono:bTel.value,
    correo:bCorreo.value,
    direccion:bDir.value,
    estatus:bEst.value,
    fechaIngreso:new Date().toLocaleDateString()
  });
  await updateDoc(doc(db,"colaboradores",c.id),{beneficiarios:c.beneficiarios});
  await cargarDesdeFirebase();
  listarBenefCol();
}

window.eliminarBenef=async (i)=>{
  const c=cacheCols[actualIndex];
  c.beneficiarios.splice(i,1);
  await updateDoc(doc(db,"colaboradores",c.id),{beneficiarios:c.beneficiarios});
  await cargarDesdeFirebase();
  listarBenefCol();
}
</script>

