<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema Cobranza - Con Cobradores</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI, sans-serif}
  body{display:flex;height:100vh;background:#f5f6fa;color:#222}
  .sidebar{width:260px;background:#fff;box-shadow:2px 0 12px rgba(0,0,0,0.06);display:flex;flex-direction:column;justify-content:space-between;padding:18px 12px}
  .sidebar h2{font-size:1.2rem;text-align:center;margin-bottom:10px;color:#333}
  .menu{display:flex;flex-direction:column;gap:6px}
  .menu button{background:none;border:none;padding:10px 12px;text-align:left;border-radius:8px;cursor:pointer;color:#333;font-size:1rem}
  .menu button.active,.menu button:hover{background:#eaf0ff;color:#1a73e8}
  .main{flex:1;padding:18px;overflow:auto}
  header{background:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.06);display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  h1{color:#1a73e8;font-size:1.05rem}
  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04);margin-bottom:12px;max-width:980px}
  form .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  label{font-weight:600;font-size:.95rem;width:140px}
  input,select,textarea,button{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:.95rem}
  textarea{min-height:70px;resize:vertical}
  .btn{background:#1a73e8;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
  .btn.warn{background:#e05d5d}
  .list{max-height:320px;overflow:auto;margin-top:8px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee}
  .small{padding:6px 8px;font-size:.85rem;border-radius:6px}
  @media(max-width:800px){.sidebar{width:100%;display:flex;flex-direction:row;gap:8px;overflow:auto}.main{padding:12px}}
</style>
</head>
<body>
  <aside class="sidebar" aria-label="Navegaci√≥n">
    <div>
      <h2>üíº Cobranza Ruta</h2>
      <nav class="menu" role="navigation">
        <button id="btnRuta" class="active">üß≠ Ruta</button>
        <button id="btnVentas">üí∞ Ventas</button>
        <button id="btnClientes">üë• Clientes</button>
        <button id="btnCobradores">üßë‚Äçüíº Cobradores</button>
        <button id="btnReportes">üìä Reportes</button>
        <button id="btnConfig">‚öôÔ∏è Configuraci√≥n</button>
      </nav>
    </div>
    <div style="text-align:center;color:#777;font-size:.9rem;padding-top:10px">¬© 2025 Sistema</div>
  </aside>

  <main class="main">
    <header>
      <h1 id="titulo">M√≥dulo: Ruta</h1>
      <div id="fechaHora" aria-live="polite"></div>
    </header>

    <!-- RUTA -->
    <section id="modRuta" class="card">
      <h3>Ruta del d√≠a</h3>
      <form id="formRuta">
        <div class="row">
          <label for="rutaCobrador">Seleccionar cobrador</label>
          <select id="rutaCobrador" style="flex:1"><option value="">-- Selecciona --</option></select>
        </div>
        <div class="row">
          <label>Filtrar por saldo</label>
          <select id="filtroSaldo" style="flex:1">
            <option value="todos">Todos</option>
            <option value="pendiente">Con saldo</option>
            <option value="pagados">Sin saldo</option>
          </select>
        </div>
      </form>
      <div id="clientesRuta" class="list"></div>
    </section>

    <!-- VENTAS -->
    <section id="modVentas" class="card" style="display:none">
      <h3>Registro de Venta</h3>
      <div style="margin-bottom:10px">
        <strong>Folio actual:</strong> <span id="folioActual">#00001</span>
      </div>
      <form id="formVentasNuevo">
        <div class="row">
          <label for="ventaCobrador">Asignar cobrador</label>
          <select id="ventaCobrador" style="flex:1"><option value="">-- Selecciona --</option></select>
        </div>
        <div class="row">
          <label for="fechaVenta">Fecha</label><input id="fechaVenta" type="date">
          <label for="articulos">Art√≠culos</label><input id="articulos" type="text" style="flex:1">
        </div>
        <div class="row">
          <label for="lugarEntrega">Lugar entrega</label><input id="lugarEntrega" type="text" style="flex:1">
          <label for="precio">Precio</label><input id="precio" type="number">
        </div>
        <div class="row">
          <label for="nombreCliente">Nombre</label><input id="nombreCliente" type="text" style="flex:1">
        </div>
        <div class="row">
          <label for="domParticular">Domicilio particular</label><input id="domParticular" type="text" style="flex:1">
        </div>
        <div class="row">
          <label for="domEmpleo">Domicilio empleo</label><input id="domEmpleo" type="text" style="flex:1">
        </div>
        <div class="row">
          <label for="pagoSemanal">Pago semanal</label><input id="pagoSemanal" type="number">
          <label for="pagoQuincenal">Pago quincenal</label><input id="pagoQuincenal" type="number">
        </div>
        <div class="row">
          <label for="horario">Horario</label><input id="horario" type="text" style="flex:1">
          <label for="lugarCobro">Lugar cobro</label><input id="lugarCobro" type="text">
        </div>
        <div class="row">
          <label for="enganche">Enganche</label><input id="enganche" type="number">
          <label for="metodoPago">M√©todo pago</label>
          <select id="metodoPago">
            <option value="">--</option><option value="Efectivo">Efectivo</option><option value="Tarjeta">Tarjeta</option><option value="Transferencia">Transferencia</option>
          </select>
        </div>
        <div class="row">
          <label for="tipoCobro">Cobro/Transferencia</label>
          <select id="tipoCobro"><option value="">--</option><option value="Cobro">Cobro</option><option value="Transferencia">Transferencia</option></select>
        </div>
        <div class="row">
          <label for="observaciones">Observaciones</label>
          <textarea id="observaciones" style="flex:1"></textarea>
        </div>

        <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
          <button id="btnAplicarVenta" class="btn" type="button">Aplicar Venta</button>
          <button id="btnImprimirVenta" class="btn" type="button">Imprimir Ticket</button>
        </div>
      </form>

      <div style="margin-top:12px">
        <h4>Ventas registradas</h4>
        <div id="listaVentas" class="list"></div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="modClientes" class="card" style="display:none">
      <h3>Clientes</h3>
      <form id="formClienteNuevo">
        <div class="row">
          <label>Nombre</label><input id="cliNombre" type="text" style="flex:1">
        </div>
        <div class="row">
          <label>Tel√©fono</label><input id="cliTelefono" type="text" style="flex:1">
        </div>
        <div style="text-align:center">
          <button id="btnGuardarCliente" class="btn" type="button">Guardar cliente</button>
        </div>
      </form>

      <div style="margin-top:12px">
        <h4>Listado</h4>
        <div id="listaClientes" class="list"></div>
      </div>
    </section>

    <!-- COBRADORES -->
    <section id="modCobradores" class="card" style="display:none">
      <h3>Cobradores</h3>
      <form id="formCobrador">
        <div class="row">
          <label>Nombre</label><input id="cobNombre" type="text" style="flex:1">
          <label>Tel√©fono</label><input id="cobTelefono" type="text">
        </div>
        <div class="row">
          <label>Email</label><input id="cobEmail" type="email" style="flex:1">
          <label>Observaciones</label><input id="cobObs" type="text">
        </div>
        <div style="text-align:center"><button id="btnGuardarCobrador" class="btn" type="button">Guardar cobrador</button></div>
      </form>

      <div style="margin-top:12px">
        <h4>Lista de cobradores</h4>
        <div id="listaCobradores" class="list"></div>
      </div>
    </section>

    <!-- REPORTES -->
    <section id="modReportes" class="card" style="display:none">
      <h3>Reportes de Abonos</h3>
      <form id="formReport">
        <div class="row">
          <label>Cliente</label><select id="filtroCliente" style="flex:1"><option value="">Todos</option></select>
          <label>Cobrador</label><select id="filtroCobrador"><option value="">Todos</option></select>
        </div>
        <div class="row">
          <label>Desde</label><input id="fInicio" type="date">
          <label>Hasta</label><input id="fFin" type="date">
        </div>
        <div style="text-align:center"><button id="btnFiltrar" class="btn" type="button">Filtrar</button></div>
      </form>
      <div style="margin-top:12px"><div id="resultReport" class="list"></div></div>
    </section>

    <!-- CONFIG -->
    <section id="modConfig" class="card" style="display:none">
      <h3>Configuraci√≥n</h3>
      <p class="muted">Ajustes generales (pendiente de implementar).</p>
    </section>

  </main>

<script>
/* ---------- UTIL Y PERSISTENCIA ---------- */
const KEY = { CLIENTES:'sc_clientes_v2', VENTAS:'sc_ventas_v2', ABONOS:'sc_abonos_v2', COBRADORES:'sc_cobradores_v2', FOLIO:'sc_folio_v2' };
function save(key,obj){localStorage.setItem(key,JSON.stringify(obj))}
function load(key){try{return JSON.parse(localStorage.getItem(key))||[];}catch(e){return []}}

/* ---------- ESTADO ---------- */
let clientes = load(KEY.CLIENTES);
let ventas = load(KEY.VENTAS);
let abonos = load(KEY.ABONOS);
let cobradores = load(KEY.COBRADORES);
let folio = parseInt(localStorage.getItem(KEY.FOLIO)||'1',10);

/* ---------- UI: Navegaci√≥n ---------- */
const sections = { btnRuta:'modRuta', btnVentas:'modVentas', btnClientes:'modClientes', btnCobradores:'modCobradores', btnReportes:'modReportes', btnConfig:'modConfig' };
Object.keys(sections).forEach(btn=>{
  document.getElementById(btn).addEventListener('click', ()=>{
    Object.values(sections).forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById(sections[btn]).style.display='block';
    document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
    document.getElementById(btn).classList.add('active');
    document.getElementById('titulo').textContent='M√≥dulo: '+document.getElementById(btn).textContent.trim();
    refreshAllSelectors();
  });
});

/* ---------- RELOJ ---------- */
function tick(){document.getElementById('fechaHora').textContent = new Date().toLocaleString()}
setInterval(tick,1000); tick();

/* ---------- RENDER HELPERS ---------- */
function refreshAllSelectors(){
  // rutaCobrador, ventaCobrador, filtroCobrador, filtroCliente
  const rutaS = document.getElementById('rutaCobrador');
  const ventaS = document.getElementById('ventaCobrador');
  const filtroC = document.getElementById('filtroCobrador');
  const filtroCli = document.getElementById('filtroCliente');

  [rutaS, ventaS, filtroC].forEach(sel=>{
    sel.innerHTML = '<option value="">-- Selecciona --</option>';
    cobradores.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nombre; sel.appendChild(o) });
  });

  // clientes selector in report
  filtroCli.innerHTML = '<option value="">Todos</option>';
  clientes.forEach(c=>{ const o=document.createElement('option'); o.value=c.nombre; o.textContent=c.nombre; filtroCli.appendChild(o) });

  // show folio
  document.getElementById('folioActual').textContent = '#' + String(folio).padStart(5,'0');
}

/* ---------- RENDER LISTAS ---------- */
function renderClientesList(){
  const cont = document.getElementById('listaClientes'); cont.innerHTML='';
  clientes.forEach((c,idx)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<div><strong>${c.nombre}</strong><div class="muted">Tel: ${c.telefono||'-'}</div></div>`;
    const actions=document.createElement('div');
    const btnEdit=document.createElement('button'); btnEdit.className='small'; btnEdit.textContent='Editar';
    btnEdit.addEventListener('click', ()=> editCliente(idx));
    const btnDel=document.createElement('button'); btnDel.className='small'; btnDel.textContent='Eliminar';
    btnDel.addEventListener('click', ()=> { if(confirm('Eliminar este cliente?')){ clientes.splice(idx,1); save(KEY.CLIENTES,clientes); renderClientesList(); refreshAllSelectors(); }});
    const btnLoc=document.createElement('button'); btnLoc.className='small'; btnLoc.textContent='Asignar ubic.';
    btnLoc.addEventListener('click', ()=> assignLocationToClient(idx));
    const btnVer=document.createElement('button'); btnVer.className='small'; btnVer.textContent='Ver ubic.';
    btnVer.addEventListener('click', ()=> { if(clientsHasLocation(idx)) window.open(clientsHasLocation(idx),'_blank'); else alert('Sin ubicaci√≥n')});
    actions.appendChild(btnEdit); actions.appendChild(btnDel); actions.appendChild(btnLoc); actions.appendChild(btnVer);
    div.appendChild(actions); cont.appendChild(div);
  });
}
function renderCobradoresList(){
  const cont=document.getElementById('listaCobradores'); cont.innerHTML='';
  cobradores.forEach((c,idx)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<div><strong>${c.nombre}</strong><div class="muted">Tel: ${c.telefono||'-'} ${c.email? ' | ' + c.email : ''}</div></div>`;
    const actions=document.createElement('div');
    const btnEdit=document.createElement('button'); btnEdit.className='small'; btnEdit.textContent='Editar';
    btnEdit.addEventListener('click', ()=> editCobrador(idx));
    const btnDel=document.createElement('button'); btnDel.className='small'; btnDel.textContent='Eliminar';
    btnDel.addEventListener('click', ()=> { if(confirm('Eliminar cobrador?')){ cobradores.splice(idx,1); save(KEY.COBRADORES,cobradores); renderCobradoresList(); refreshAllSelectors(); }});
    actions.appendChild(btnEdit); actions.appendChild(btnDel);
    div.appendChild(actions); cont.appendChild(div);
  });
}
function renderVentasList(){
  const cont=document.getElementById('listaVentas'); cont.innerHTML='';
  ventas.slice().reverse().forEach((v,idx)=>{
    const div=document.createElement('div'); div.className='item';
    const cob = cobradores.find(x=>x.id===v.cobrador);
    const cobName = cob? cob.nombre : (v.cobradorName||'-');
    div.innerHTML = `<div><strong>${v.nombre||'(sin nombre)'}</strong><div class="muted">${new Date(v.createdAt).toLocaleString()} ‚Äî ${v.articulos} ‚Äî $${Number(v.precio).toFixed(2)} | ${cobName}</div></div>`;
    const actions=document.createElement('div');
    const btnImp=document.createElement('button'); btnImp.className='small'; btnImp.textContent='Imprimir';
    btnImp.addEventListener('click', ()=> printTicket(v));
    actions.appendChild(btnImp);
    div.appendChild(actions); cont.appendChild(div);
  });
}

/* ---------- COBRADORES: CRUD ---------- */
document.getElementById('btnGuardarCobrador').addEventListener('click', ()=>{
  const nombre = document.getElementById('cobNombre').value.trim();
  const telefono = document.getElementById('cobTelefono').value.trim();
  const email = document.getElementById('cobEmail').value.trim();
  const obs = document.getElementById('cobObs').value.trim();
  if(!nombre){ alert('El nombre es requerido'); return; }
  const newC = { id: 'cob_'+Date.now(), nombre, telefono, email, obs };
  cobradores.push(newC);
  save(KEY.COBRADORES, cobradores);
  document.getElementById('formCobrador').reset();
  renderCobradoresList(); refreshAllSelectors();
});

/* Editar cobrador */
function editCobrador(idx){
  const c = cobradores[idx];
  const nn = prompt('Nombre:', c.nombre);
  if(!nn) return;
  const nt = prompt('Tel√©fono:', c.telefono || '');
  const ne = prompt('Email:', c.email || '');
  const no = prompt('Observaciones:', c.obs || '');
  cobradores[idx] = { ...c, nombre: nn.trim(), telefono: (nt||'').trim(), email: (ne||'').trim(), obs: (no||'').trim() };
  save(KEY.COBRADORES, cobradores);
  renderCobradoresList(); refreshAllSelectors();
}

/* ---------- CLIENTES: CRUD ---------- */
document.getElementById('btnGuardarCliente').addEventListener('click', ()=>{
  const nombre = document.getElementById('cliNombre').value.trim();
  const tel = document.getElementById('cliTelefono').value.trim();
  if(!nombre){alert('Nombre requerido'); return;}
  clientes.push({ id: 'cli_'+Date.now(), nombre, telefono: tel, ubicacion: null, saldo: 0});
  save(KEY.CLIENTES, clientes);
  document.getElementById('formClienteNuevo').reset();
  renderClientesList(); refreshAllSelectors();
});

function editCliente(idx){
  const c = clientes[idx];
  const nn = prompt('Nombre:', c.nombre);
  if(!nn) return;
  const nt = prompt('Tel√©fono:', c.telefono||'');
  clientes[idx].nombre = nn.trim();
  clientes[idx].telefono = (nt||'').trim();
  save(KEY.CLIENTES, clientes);
  renderClientesList(); refreshAllSelectors();
}

function assignLocationToClient(idx){
  if(!navigator.geolocation){ alert('Geolocalizaci√≥n no disponible'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    clientes[idx].ubicacion = `https://www.google.com/maps?q=${lat},${lng}`;
    save(KEY.CLIENTES, clientes);
    alert('Ubicaci√≥n asignada: '+lat+','+lng);
    renderClientesList();
  }, err=> alert('Error: '+err.message), { enableHighAccuracy:true, timeout:10000 });
}
function clientsHasLocation(idx){ return clientes[idx] && clientes[idx].ubicacion ? clientes[idx].ubicacion : null }

/* ---------- VENTAS ---------- */
document.getElementById('btnAplicarVenta').addEventListener('click', ()=>{
  const v = {
    id: 'v_'+Date.now(),
    cobrador: document.getElementById('ventaCobrador').value || '',
    cobradorName: (function(){ const cb = cobradores.find(x=>x.id===document.getElementById('ventaCobrador').value); return cb? cb.nombre : ''; })(),
    fecha: document.getElementById('fechaVenta').value || '',
    articulos: document.getElementById('articulos').value || '',
    lugarEntrega: document.getElementById('lugarEntrega').value || '',
    precio: Number(document.getElementById('precio').value || 0),
    nombre: document.getElementById('nombreCliente').value||'',
    domParticular: document.getElementById('domParticular').value||'',
    domEmpleo: document.getElementById('domEmpleo').value||'',
    pagoSemanal: Number(document.getElementById('pagoSemanal').value || 0),
    pagoQuincenal: Number(document.getElementById('pagoQuincenal').value || 0),
    horario: document.getElementById('horario').value||'',
    lugarCobro: document.getElementById('lugarCobro').value||'',
    enganche: Number(document.getElementById('enganche').value || 0),
    metodoPago: document.getElementById('metodoPago').value||'',
    tipoCobro: document.getElementById('tipoCobro').value||'',
    observaciones: document.getElementById('observaciones').value||'',
    createdAt: new Date().toISOString(),
    folio: folio
  };
  ventas.push(v); save(KEY.VENTAS, ventas);
  folio = folio + 1; localStorage.setItem(KEY.FOLIO, String(folio));
  refreshAllSelectors(); renderVentasList();
  alert('Venta guardada. Folio asignado: #' + String(v.folio).padStart(5,'0'));
  document.getElementById('formVentasNuevo').reset();
});

/* Imprimir: toma la venta m√°s reciente o la que le pases */
document.getElementById('btnImprimirVenta').addEventListener('click', ()=>{
  if(ventas.length===0){ alert('No hay ventas'); return; }
  printTicket(ventas[ventas.length-1]);
});

function printTicket(v){
  const fechaImp = new Date();
  const cob = cobradores.find(x=>x.id===v.cobrador);
  const html = `
    <div style="font-family:Segoe UI, sans-serif;padding:18px;width:320px">
      <h2 style="text-align:center;font-weight:700">Promociones Culturales de M√©xico</h2>
      <hr>
      <p><strong>Folio:</strong> #${String(v.folio).padStart(5,'0')}</p>
      <p><strong>Fecha venta:</strong> ${v.fecha || '-'}</p>
      <p><strong>Fecha impresi√≥n:</strong> ${fechaImp.toLocaleDateString()}</p>
      <p><strong>Hora impresi√≥n:</strong> ${fechaImp.toLocaleTimeString()}</p>
      <hr>
      <p><strong>Cliente:</strong> ${v.nombre || '-'}</p>
      <p><strong>Art√≠culos:</strong> ${v.articulos || '-'}</p>
      <p><strong>Lugar entrega:</strong> ${v.lugarEntrega || '-'}</p>
      <p><strong>Precio:</strong> $${Number(v.precio).toFixed(2)}</p>
      <p><strong>Enganche:</strong> $${Number(v.enganche).toFixed(2)}</p>
      <p><strong>M√©todo:</strong> ${v.metodoPago || '-'}</p>
      <p><strong>Cobro/Transf:</strong> ${v.tipoCobro || '-'}</p>
      <p><strong>Cobrador:</strong> ${cob? cob.nombre : v.cobradorName || '-'}</p>
      <p><strong>Pago semanal:</strong> ${v.pagoSemanal? '$'+v.pagoSemanal : '-'}</p>
      <p><strong>Pago quincenal:</strong> ${v.pagoQuincenal? '$'+v.pagoQuincenal : '-'}</p>
      <p><strong>Horario:</strong> ${v.horario || '-'}</p>
      <p><strong>Lugar cobro:</strong> ${v.lugarCobro || '-'}</p>
      <p><strong>Observaciones:</strong> ${v.observaciones || '-'}</p>
      <hr>
      <p style="text-align:center;font-size:0.9em">Gracias por su compra</p>
    </div>`;
  const w = window.open('','', 'width=420,height=700');
  w.document.write(html);
  w.document.close();
  w.print();
}

/* ---------- RUTA: mostrar clientes asignados y aplicar abonos ---------- */
document.getElementById('rutaCobrador').addEventListener('change', showClientsForRoute);
document.getElementById('filtroSaldo').addEventListener('change', showClientsForRoute);

function showClientsForRoute(){
  const cid = document.getElementById('rutaCobrador').value;
  const filtro = document.getElementById('filtroSaldo').value;
  const cont = document.getElementById('clientesRuta'); cont.innerHTML='';
  if(!cid) { cont.innerHTML = '<div class="muted">Selecciona un cobrador</div>'; return; }

  // Para demo: todos los clientes son asignados. In real: use assignment model.
  const list = clientes.map(c=>({ ...c }));
  const filtered = list.filter(c=>{
    if(filtro==='pendiente') return (Number(c.saldo)||0) > 0;
    if(filtro==='pagados') return (Number(c.saldo)||0) <= 0;
    return true;
  });

  filtered.forEach((c, idx)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<div><strong>${c.nombre}</strong><div class="muted">Saldo: $${Number(c.saldo||0).toFixed(2)}</div></div>`;
    const right=document.createElement('div');
    const btnUb=document.createElement('button'); btnUb.className='small'; btnUb.textContent='Ver Ubic';
    btnUb.addEventListener('click', ()=>{ if(c.ubicacion) window.open(c.ubicacion,'_blank'); else alert('Sin ubicacion')});
    const inpConcept=document.createElement('input'); inpConcept.placeholder='Concepto';
    const inpAbono=document.createElement('input'); inpAbono.placeholder='Abono'; inpAbono.type='number';
    inpConcept.style.marginRight='6px'; inpAbono.style.width='90px';
    const btnAp=document.createElement('button'); btnAp.className='small'; btnAp.textContent='Aplicar';
    btnAp.addEventListener('click', ()=>{
      const concepto = inpConcept.value.trim(); const ab = Number(inpAbono.value||0);
      if(!concepto || ab<=0){ alert('Concepto y abono v√°lidos'); return; }
      // actualizar saldo cliente globalmente
      const idxCli = clientes.findIndex(x=>x.id === c.id);
      if(idxCli === -1){ alert('Cliente no existe'); return; }
      const anterior = Number(clientes[idxCli].saldo||0);
      let nuevo = anterior - ab; if(nuevo<0) nuevo=0;
      clientes[idxCli].saldo = nuevo;
      save(KEY.CLIENTES, clientes);
      // guardar abono
      abonos.push({ id:'a_'+Date.now(), cliente:c.nombre, cobrador:cid, concepto, abono:ab, fecha: new Date().toISOString()});
      save(KEY.ABONOS, abonos);
      showClientsForRoute(); renderClientesList(); renderReportResults(); alert('Abono aplicado');
      // imprimir comprobante
      const ticket = {
        folio: '(comprobante)', cliente:c.nombre, concepto, abono:ab, anterior, restante: nuevo, cobrador: (cobradores.find(x=>x.id===cid)||{}).nombre || ''
      };
      printReceipt(ticket);
    });

    right.appendChild(btnUb);
    right.appendChild(inpConcept);
    right.appendChild(inpAbono);
    right.appendChild(btnAp);
    div.appendChild(right);
    cont.appendChild(div);
  });
}

/* print comprobante de abono */
function printReceipt(t){
  const html = `
    <div style="font-family:Segoe UI;padding:16px;width:320px">
      <h2 style="text-align:center;font-weight:700">Comprobante de Pago</h2><hr>
      <p><strong>Cliente:</strong> ${t.cliente}</p>
      <p><strong>Cobrador:</strong> ${t.cobrador}</p>
      <p><strong>Concepto:</strong> ${t.concepto}</p>
      <p><strong>Saldo anterior:</strong> $${Number(t.anterior).toFixed(2)}</p>
      <p><strong>Abono:</strong> $${Number(t.abono).toFixed(2)}</p>
      <p><strong>Saldo restante:</strong> $${Number(t.restante).toFixed(2)}</p>
      <hr><p style="text-align:center">Este comprobante sirve como constancia de pago</p>
    </div>`;
  const w = window.open('','', 'width=420,height=620');
  w.document.write(html); w.document.close(); w.print();
}

/* ---------- REPORTES ---------- */
document.getElementById('btnFiltrar').addEventListener('click', renderReportResults);
function renderReportResults(){
  const cli = document.getElementById('filtroCliente').value;
  const cob = document.getElementById('filtroCobrador').value;
  const fI = document.getElementById('fInicio').value;
  const fF = document.getElementById('fFin').value;
  const cont = document.getElementById('resultReport'); cont.innerHTML='';
  let list = abonos.slice();
  if(cli) list = list.filter(a=>a.cliente === cli);
  if(cob) list = list.filter(a=>a.cobrador === cob);
  if(fI) list = list.filter(a=> new Date(a.fecha) >= new Date(fI+'T00:00:00'));
  if(fF) list = list.filter(a=> new Date(a.fecha) <= new Date(fF+'T23:59:59'));
  if(list.length===0){ cont.innerHTML = '<div class="muted">No hay registros</div>'; return; }
  list.forEach(a=>{
    const div=document.createElement('div'); div.className='item';
    div.textContent = `${new Date(a.fecha).toLocaleString()} ‚Äî ${a.cliente} | ${a.concepto} | $${Number(a.abono).toFixed(2)} | ${ (cobradores.find(x=>x.id===a.cobrador)||{}).nombre || a.cobrador }`;
    cont.appendChild(div);
  });
}

/* ---------- INICIO: render inicial ---------- */
function renderInitial(){
  renderClientesList();
  renderCobradoresList();
  renderVentasList();
  refreshAllSelectors();
  renderReportResults();
}
renderInitial();

</script>
</body>
</html>

