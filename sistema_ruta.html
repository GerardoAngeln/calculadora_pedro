<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema de Cobranza ‚Äî Final</title>

<!-- Leaflet CSS (OpenStreetMap, sin API key) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+e2g3T6k2v2l+XwQh0V6w1sKqz5v1qv+v5cNw6v4M=" crossorigin=""/>

<style>
  :root{
    --bg:#f5f6fa; --panel:#fff; --primary:#1a73e8; --text:#222; --muted:#666;
    --card-shadow: 0 2px 10px rgba(0,0,0,0.06);
  }
  [data-theme="dark"]{
    --bg:#0f1720; --panel:#121316; --primary:#4ea3ff; --text:#e6eefc; --muted:#9aa6bf;
    --card-shadow: 0 2px 10px rgba(0,0,0,0.4);
  }

  *{box-sizing:border-box;font-family:Inter, "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);}
  .app{display:flex;height:100vh;overflow:hidden;}
  .sidebar{width:260px;background:var(--panel);box-shadow:2px 0 12px rgba(0,0,0,0.04);padding:18px;display:flex;flex-direction:column;gap:12px}
  .brand{font-weight:700;color:var(--primary);font-size:1.05rem}
  .menu{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .menu button{background:none;border:none;padding:10px 12px;border-radius:8px;text-align:left;cursor:pointer;color:var(--text);font-weight:600}
  .menu button.active,.menu button:hover{background:rgba(26,115,232,0.08);color:var(--primary)}
  .main{flex:1;display:flex;flex-direction:column;overflow:auto;padding:16px 18px;gap:12px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .header-left{display:flex;flex-direction:column}
  .title{font-size:1.05rem;color:var(--primary);margin:0}
  .sub{color:var(--muted);font-size:.95rem}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--primary);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(0,0,0,0.06)}
  .card{background:var(--panel);padding:12px;border-radius:10px;box-shadow:var(--card-shadow)}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .full{grid-column:1/-1}
  label{display:block;font-weight:700;margin-bottom:6px;color:var(--text)}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;background:transparent;color:var(--text)}
  textarea{min-height:90px;resize:vertical}
  .list{max-height:340px;overflow:auto}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(0,0,0,0.04)}
  .muted{color:var(--muted);font-size:.94rem}
  .small{font-size:.85rem;padding:6px 8px;border-radius:6px}
  .row{display:flex;gap:8px;align-items:center}
  .center{text-align:center}
  #mapAll,#mapClientes,#mapRuta{height:320px;border-radius:8px}
  /* toast */
  .toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
  .toast{background:rgba(0,0,0,0.8);color:white;padding:10px 12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.4)}
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9998}
  .modal{background:var(--panel);padding:18px;border-radius:10px;min-width:320px;box-shadow:var(--card-shadow)}
  /* responsive */
  @media(max-width:980px){
    .app{flex-direction:column}
    .sidebar{width:100%;display:flex;flex-direction:row;gap:8px;overflow:auto}
    .menu{flex-direction:row}
    .main{padding:12px}
    .grid{grid-template-columns:1fr}
  }
  @media(max-width:520px){
    .btn{padding:8px 6px;font-size:.95rem}
    input,select,textarea{padding:10px}
  }
</style>
</head>
<body>

<div id="app" class="app" data-theme="light">
  <!-- SIDEBAR -->
  <aside class="sidebar card">
    <div>
      <div class="brand">üíº Promociones Culturales</div>
      <div class="muted" style="margin-top:6px">Sistema de Cobranza en Ruta</div>
    </div>

    <nav class="menu" aria-label="main menu">
      <button id="navDashboard" class="active">üè† Resumen</button>
      <button id="navRuta">üß≠ Ruta</button>
      <button id="navVentas">üí∞ Ventas</button>
      <button id="navClientes">üë• Clientes</button>
      <button id="navCobradores">üßë‚Äçüíº Cobradores</button>
      <button id="navReportes">üìä Reportes</button>
      <button id="navConfig">‚öôÔ∏è Configuraci√≥n</button>
    </nav>

    <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="toggleTheme" class="small">üåô</button>
        <button id="btnLogout" class="small">Salir</button>
      </div>
      <div class="muted center">¬© 2025 Promociones Culturales</div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header>
      <div class="header-left">
        <h2 id="pageTitle" class="title">M√≥dulo: Resumen</h2>
        <div id="roleInfo" class="muted">Usuario: <strong id="currentRole">‚Äî</strong></div>
      </div>
      <div class="controls">
        <div id="fechaHora" class="muted"></div>
        <button id="openQuickAdd" class="btn ghost">+ Nueva Venta</button>
      </div>
    </header>

    <!-- DASHBOARD -->
    <section id="pageDashboard" class="card">
      <div class="grid">
        <div class="card">
          <h4>Ventas del d√≠a</h4>
          <div id="dashboardVentas" class="muted">0</div>
        </div>
        <div class="card">
          <h4>Abonos del d√≠a</h4>
          <div id="dashboardAbonos" class="muted">0</div>
        </div>
        <div class="card full">
          <h4>Mapa general - Clientes</h4>
          <div id="mapAll"></div>
        </div>
      </div>
    </section>

    <!-- RUTA -->
    <section id="pageRuta" class="card" style="display:none">
      <h3>Ruta del d√≠a</h3>
      <div class="grid">
        <div>
          <label>Seleccionar cobrador</label>
          <select id="rutaCobrador"></select>
          <label style="margin-top:10px">Filtrar por saldo</label>
          <select id="rutaFiltroSaldo"><option value="todos">Todos</option><option value="pendiente">Con saldo</option><option value="pagados">Sin saldo</option></select>
          <div style="margin-top:10px">
            <h4>Clientes asignados</h4>
            <div id="listaRuta" class="list"></div>
          </div>
        </div>
        <div>
          <h4>Mapa de la ruta</h4>
          <div id="mapRuta"></div>
        </div>
      </div>
    </section>

    <!-- VENTAS -->
    <section id="pageVentas" class="card" style="display:none">
      <h3>Registro de Venta</h3>
      <div class="grid">
        <div>
          <div class="card">
            <div style="margin-bottom:8px"><strong>Folio actual: </strong><span id="folioDisplay">#00001</span></div>
            <form id="formVenta">
              <label>Asignar cobrador</label><select id="ventaCobrador"></select>
              <label>Fecha de venta</label><input id="ventaFecha" type="date" />
              <label>Art√≠culos</label><input id="ventaArticulos" />
              <label>Lugar de entrega</label><input id="ventaLugarEntrega" />
              <label>Precio</label><input id="ventaPrecio" type="number" />
              <label>Nombre</label><input id="ventaNombre" />
            </form>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveVentaBtn" class="btn">Aplicar Venta</button>
              <button id="printLastVenta" class="btn ghost">Imprimir Ticket</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h4>Ventas registradas</h4>
            <div id="listaVentas" class="list"></div>
          </div>
        </div>

        <div>
          <div class="card">
            <h4>Detalles extendidos</h4>
            <label>Pago semanal</label><input id="ventaPagoSemanal" type="number" />
            <label>Pago quincenal</label><input id="ventaPagoQuincenal" type="number" />
            <label>Horario</label><input id="ventaHorario" />
            <label>Lugar de cobro</label><input id="ventaLugarCobro" />
            <label>Enganche</label><input id="ventaEnganche" type="number" />
            <label>M√©todo de pago</label>
            <select id="ventaMetodoPago"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select>
            <label>Tipo (Cobro/Transferencia)</label>
            <select id="ventaTipoCobro"><option>Cobro</option><option>Transferencia</option></select>
            <label>Observaciones</label><textarea id="ventaObservaciones"></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="pageClientes" class="card" style="display:none">
      <h3>Clientes</h3>
      <div class="grid">
        <div>
          <form id="formCliente">
            <label>Nombre</label><input id="cliNombre" />
            <label>Tel√©fono</label><input id="cliTelefono" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveCliente" class="btn">Guardar Cliente</button>
              <button id="btnVerTodosMapa" class="btn ghost">Ver todos en mapa</button>
            </div>
          </form>
          <div class="card" style="margin-top:12px">
            <h4>Listado</h4>
            <div id="listaClientes" class="list"></div>
          </div>
        </div>
        <div>
          <h4>Mapa de clientes</h4>
          <div id="mapClientes"></div>
        </div>
      </div>
    </section>

    <!-- COBRADORES -->
    <section id="pageCobradores" class="card" style="display:none">
      <h3>Cobradores</h3>
      <form id="formCobrador">
        <div class="row">
          <div style="flex:1">
            <label>Nombre</label><input id="cobNombre" />
          </div>
          <div style="width:180px">
            <label>Tel√©fono</label><input id="cobTelefono" />
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label>Email</label><input id="cobEmail" />
          </div>
          <div style="width:180px">
            <label>Zona</label><input id="cobZona" />
          </div>
        </div>
        <div style="text-align:center;margin-top:8px">
          <button id="saveCobrador" class="btn">Guardar cobrador</button>
        </div>
      </form>

      <div style="margin-top:12px">
        <h4>Lista</h4>
        <div id="listaCobradores" class="list"></div>
      </div>
    </section>

    <!-- REPORTES -->
    <section id="pageReportes" class="card" style="display:none">
      <h3>Reportes de Abonos</h3>
      <form id="formReport" class="grid">
        <div>
          <label>Cliente</label><select id="reportCliente"></select>
        </div>
        <div>
          <label>Cobrador</label><select id="reportCobrador"></select>
        </div>
        <div>
          <label>Desde</label><input id="reportDesde" type="date" />
        </div>
        <div>
          <label>Hasta</label><input id="reportHasta" type="date" />
        </div>
        <div class="full center" style="margin-top:8px">
          <button id="btnRunReport" class="btn">Filtrar</button>
          <button id="btnExportCSV" class="btn ghost">Exportar CSV</button>
          <button id="btnExportPDF" class="btn ghost">Exportar PDF</button>
        </div>
      </form>
      <div style="margin-top:10px">
        <div id="reportResults" class="list"></div>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="pageConfig" class="card" style="display:none">
      <h3>Configuraci√≥n</h3>
      <div class="row">
        <label>Modo oscuro</label>
        <button id="toggleThemeConfig" class="btn ghost">Alternar</button>
      </div>
      <p class="muted" style="margin-top:8px">Ajustes futuros: autenticaci√≥n, sincronizaci√≥n en la nube, backup autom√°tico.</p>
    </section>

  </main>
</div>

<!-- Toast wrapper -->
<div class="toast-wrap" id="toasts" aria-live="polite"></div>

<!-- Role modal -->
<div id="modalRole" class="modal-back" style="display:none">
  <div class="modal">
    <h3>Selecciona tu rol</h3>
    <p class="muted">Elige "Cobrador" para ver solo Ruta y Ventas, o "Administrador" para todo el sistema.</p>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:center">
      <button id="roleCobrador" class="btn">Cobrador</button>
      <button id="roleAdmin" class="btn ghost">Administrador</button>
    </div>
  </div>
</div>

<!-- Dependencies -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o8M4f2r3rD2t2kLzqV/4JY1rKkqg2lV4gqXb0d5QmT8=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ============================
   UTIL / PERSISTENCIA
   ============================ */
const LS = {
  CLIENTES: 'sc_clientes_v4',
  COBRADORES: 'sc_cobradores_v4',
  VENTAS: 'sc_ventas_v4',
  ABONOS: 'sc_abonos_v4',
  FOLIO: 'sc_folio_v4',
  THEME: 'sc_theme_v4',
  ROLE: 'sc_role_v4'
};
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function load(key){ try { return JSON.parse(localStorage.getItem(key) || 'null') || []; } catch(e){ return []; } }

/* ============================
   ESTADO INICIAL
   ============================ */
let clientes = load(LS.CLIENTES) || [];
let cobradores = load(LS.COBRADORES) || [];
let ventas = load(LS.VENTAS) || [];
let abonos = load(LS.ABONOS) || [];
let folio = parseInt(localStorage.getItem(LS.FOLIO) || '1', 10);
let currentRole = localStorage.getItem(LS.ROLE) || null;

/* ============================
   HELPERS UI
   ============================ */
function toast(msg, timeout=2500){
  const wrap = document.getElementById('toasts');
  const el = document.createElement('div'); el.className='toast'; el.textContent = msg;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity=0; setTimeout(()=>el.remove(),400); }, timeout);
}
function formatMoney(n){ return Number(n||0).toFixed(2); }
function padFolio(n){ return String(n).padStart(5,'0'); }

/* ============================
   THEME
   ============================ */
const appEl = document.getElementById('app');
function setTheme(theme){
  appEl.setAttribute('data-theme', theme);
  localStorage.setItem(LS.THEME, theme);
  document.getElementById('toggleTheme').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}
const savedTheme = localStorage.getItem(LS.THEME) || 'light';
setTheme(savedTheme);

/* ============================
   FECHA / ROLE MODAL
   ============================ */
function tick(){ document.getElementById('fechaHora').textContent = new Date().toLocaleString(); }
setInterval(tick,1000); tick();

function openRoleModal(){ document.getElementById('modalRole').style.display='flex'; }
function closeRoleModal(){ document.getElementById('modalRole').style.display='none'; }

document.getElementById('roleCobrador').addEventListener('click', ()=>{
  currentRole = 'Cobrador'; localStorage.setItem(LS.ROLE, currentRole); initRole(); closeRoleModal();
});
document.getElementById('roleAdmin').addEventListener('click', ()=>{
  currentRole = 'Administrador'; localStorage.setItem(LS.ROLE, currentRole); initRole(); closeRoleModal();
});

/* ============================
   NAVIGATION
   ============================ */
const pages = {
  navDashboard: 'pageDashboard',
  navRuta: 'pageRuta',
  navVentas: 'pageVentas',
  navClientes: 'pageClientes',
  navCobradores: 'pageCobradores',
  navReportes: 'pageReportes',
  navConfig: 'pageConfig'
};
Object.keys(pages).forEach(btnId=>{
  const el = document.getElementById(btnId);
  el.addEventListener('click', ()=>{
    Object.values(pages).forEach(pid => document.getElementById(pid).style.display = 'none');
    document.getElementById(pages[btnId]).style.display = 'block';
    document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('pageTitle').textContent = 'M√≥dulo: ' + el.textContent.trim();
    refreshSelectors();
  });
});

/* ============================
   PERSIST Y RENDER HELPERS
   ============================ */
function persistAll(){
  save(LS.CLIENTES, clientes);
  save(LS.COBRADORES, cobradores);
  save(LS.VENTAS, ventas);
  save(LS.ABONOS, abonos);
  localStorage.setItem(LS.FOLIO, String(folio));
}
function refreshSelectors(){
  const selRuta = document.getElementById('rutaCobrador');
  const selVenta = document.getElementById('ventaCobrador');
  const selReportCb = document.getElementById('reportCobrador');
  [selRuta, selVenta, selReportCb].forEach(sel=>{
    if(!sel) return;
    sel.innerHTML = '<option value="">-- Selecciona --</option>';
    cobradores.forEach(c=>{ const o=document.createElement('option'); o.value = c.id; o.textContent = c.nombre; sel.appendChild(o) });
  });
  const selReportCli = document.getElementById('reportCliente');
  if(selReportCli){
    selReportCli.innerHTML = '<option value="">Todos</option>';
    clientes.forEach(c=>{ const o=document.createElement('option'); o.value = c.id; o.textContent = c.nombre; selReportCli.appendChild(o) });
  }
  document.getElementById('folioDisplay').textContent = '#' + padFolio(folio);
}

/* render lists */
function renderClientes(){
  const container = document.getElementById('listaClientes'); container.innerHTML='';
  clientes.forEach((c, idx)=>{
    const item = document.createElement('div'); item.className='item';
    const left = document.createElement('div'); left.innerHTML = `<strong>${c.nombre}</strong><div class="muted">Tel: ${c.telefono||'-'} ‚Ä¢ Saldo: $${formatMoney(c.saldo)}</div>`;
    const actions = document.createElement('div');
    const btnEdit = document.createElement('button'); btnEdit.className='small'; btnEdit.textContent='Editar';
    btnEdit.addEventListener('click', ()=> editCliente(idx));
    const btnDel = document.createElement('button'); btnDel.className='small'; btnDel.textContent='Eliminar';
    btnDel.addEventListener('click', ()=> { if(confirm('Eliminar cliente?')){ clientes.splice(idx,1); persistAll(); renderClientes(); refreshSelectors(); toast('Cliente eliminado'); }});
    const btnLoc = document.createElement('button'); btnLoc.className='small'; btnLoc.textContent='Asignar ubic.';
    btnLoc.addEventListener('click', ()=> assignLocationToClient(idx));
    const btnVer = document.createElement('button'); btnVer.className='small'; btnVer.textContent='Ver ubic.';
    btnVer.addEventListener('click', ()=> { if(c.ubicacion) window.open(c.ubicacion,'_blank'); else toast('Cliente sin ubicaci√≥n'); });
    actions.appendChild(btnEdit); actions.appendChild(btnDel); actions.appendChild(btnLoc); actions.appendChild(btnVer);
    item.appendChild(left); item.appendChild(actions); container.appendChild(item);
  });
}

function renderCobradores(){
  const cont = document.getElementById('listaCobradores'); cont.innerHTML='';
  cobradores.forEach((cb, idx)=>{
    const item = document.createElement('div'); item.className='item';
    const left = document.createElement('div'); left.innerHTML = `<strong>${cb.nombre}</strong><div class="muted">${cb.telefono||'-'} ${cb.zona? '‚Ä¢ Zona: '+cb.zona : ''}</div>`;
    const actions = document.createElement('div');
    const btnEdit = document.createElement('button'); btnEdit.className='small'; btnEdit.textContent='Editar';
    btnEdit.addEventListener('click', ()=> editCobrador(idx));
    const btnDel = document.createElement('button'); btnDel.className='small'; btnDel.textContent='Eliminar';
    btnDel.addEventListener('click', ()=> { if(confirm('Eliminar cobrador?')){ cobradores.splice(idx,1); persistAll(); renderCobradores(); refreshSelectors(); toast('Cobrador eliminado'); }});
    actions.appendChild(btnEdit); actions.appendChild(btnDel);
    item.appendChild(left); item.appendChild(actions); cont.appendChild(item);
  });
}

function renderVentasList(){
  const cont = document.getElementById('listaVentas'); cont.innerHTML='';
  ventas.slice().reverse().forEach(v=>{
    const item = document.createElement('div'); item.className='item';
    const cob = cobradores.find(c=>c.id===v.cobrador);
    item.innerHTML = `<div><strong>${v.nombre||'(sin nombre)'}</strong><div class="muted">${new Date(v.createdAt).toLocaleString()} ‚Ä¢ ${v.articulos} ‚Ä¢ $${formatMoney(v.precio)} ‚Ä¢ ${cob? cob.nombre : '-'}</div></div>
      <div><button class="small" onclick="printTicketById('${v.id}')">Imprimir</button></div>`;
    cont.appendChild(item);
  });
}

/* ============================
   COBRADORES CRUD
   ============================ */
document.getElementById('saveCobrador').addEventListener('click', ()=>{
  const n = document.getElementById('cobNombre').value.trim();
  const t = document.getElementById('cobTelefono').value.trim();
  const e = document.getElementById('cobEmail').value.trim();
  const z = document.getElementById('cobZona').value.trim();
  if(!n){ toast('Nombre requerido'); return; }
  cobradores.push({ id: 'cb_' + Date.now(), nombre: n, telefono: t, email: e, zona: z });
  persistAll(); renderCobradores(); refreshSelectors();
  document.getElementById('formCobrador').reset();
  toast('Cobrador guardado');
});

function editCobrador(idx){
  const cb = cobradores[idx];
  const nn = prompt('Nombre', cb.nombre);
  if(!nn) return;
  const nt = prompt('Tel√©fono', cb.telefono||'');
  const nz = prompt('Zona', cb.zona||'');
  cobradores[idx].nombre = nn.trim();
  cobradores[idx].telefono = (nt||'').trim();
  cobradores[idx].zona = (nz||'').trim();
  persistAll(); renderCobradores(); refreshSelectors(); toast('Cobrador actualizado');
}

/* ============================
   CLIENTES CRUD
   ============================ */
document.getElementById('saveCliente').addEventListener('click', ()=>{
  const nombre = document.getElementById('cliNombre').value.trim();
  const tel = document.getElementById('cliTelefono').value.trim();
  if(!nombre){ toast('Nombre requerido'); return; }
  clientes.push({ id: 'cl_'+Date.now(), nombre, telefono: tel, ubicacion: null, lat:null, lng:null, saldo: 0 });
  persistAll(); renderClientes(); refreshSelectors();
  document.getElementById('formCliente').reset();
  toast('Cliente agregado');
});

function editCliente(idx){
  const c = clientes[idx];
  const nn = prompt('Nombre', c.nombre);
  if(!nn) return;
  const nt = prompt('Tel√©fono', c.telefono||'');
  clientes[idx].nombre = nn.trim();
  clientes[idx].telefono = (nt||'').trim();
  persistAll(); renderClientes(); refreshSelectors(); toast('Cliente actualizado');
}
function assignLocationToClient(idx){
  if(!navigator.geolocation){ toast('Geolocalizaci√≥n no disponible'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    clientes[idx].lat = pos.coords.latitude;
    clientes[idx].lng = pos.coords.longitude;
    clientes[idx].ubicacion = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
    persistAll(); renderClientes(); toast('Ubicaci√≥n asignada');
  }, err => toast('Error al obtener ubicaci√≥n: '+err.message), { enableHighAccuracy:true, timeout:10000 });
}

/* ============================
   VENTAS (folio, save, ticket + QR)
   ============================ */
function addVentaFromForm(){
  const vId = 'v_' + Date.now();
  const venta = {
    id: vId,
    cobrador: document.getElementById('ventaCobrador').value || '',
    createdAt: new Date().toISOString(),
    fecha: document.getElementById('ventaFecha').value || '',
    articulos: document.getElementById('ventaArticulos').value || '',
    lugarEntrega: document.getElementById('ventaLugarEntrega').value || '',
    precio: Number(document.getElementById('ventaPrecio').value || 0),
    nombre: document.getElementById('ventaNombre').value || '',
    pagoSemanal: Number(document.getElementById('ventaPagoSemanal').value || 0),
    pagoQuincenal: Number(document.getElementById('ventaPagoQuincenal').value || 0),
    horario: document.getElementById('ventaHorario').value || '',
    lugarCobro: document.getElementById('ventaLugarCobro').value || '',
    enganche: Number(document.getElementById('ventaEnganche').value || 0),
    metodoPago: document.getElementById('ventaMetodoPago').value || '',
    tipoCobro: document.getElementById('ventaTipoCobro').value || '',
    observaciones: document.getElementById('ventaObservaciones').value || '',
    folio: folio
  };
  ventas.push(venta); persistAll();
  folio++; localStorage.setItem(LS.FOLIO, String(folio));
  refreshSelectors(); renderVentasList(); toast('Venta registrada (folio #' + padFolio(venta.folio) + ')');
  document.getElementById('formVenta').reset();
}
document.getElementById('saveVentaBtn').addEventListener('click', addVentaFromForm);
document.getElementById('printLastVenta').addEventListener('click', ()=>{ if(ventas.length===0){ toast('No hay ventas'); return; } printTicket(ventas[ventas.length-1]); });

function printTicket(v){
  const printWindow = window.open('','_blank','width=420,height=700');
  const fechaNow = new Date();
  const cobr = cobradores.find(c=>c.id===v.cobrador);
  const docHtml = `
    <html><head><title>Ticket</title></head><body style="font-family:Segoe UI, sans-serif;padding:12px">
      <h2 style="text-align:center;font-weight:700">Promociones Culturales de M√©xico</h2>
      <hr>
      <p><strong>Folio:</strong> #${padFolio(v.folio)}</p>
      <p><strong>Fecha venta:</strong> ${v.fecha || '-'}</p>
      <p><strong>Fecha impresi√≥n:</strong> ${fechaNow.toLocaleDateString()}</p>
      <p><strong>Hora impresi√≥n:</strong> ${fechaNow.toLocaleTimeString()}</p>
      <hr>
      <p><strong>Cliente:</strong> ${v.nombre || '-'}</p>
      <p><strong>Art√≠culos:</strong> ${v.articulos || '-'}</p>
      <p><strong>Lugar entrega:</strong> ${v.lugarEntrega || '-'}</p>
      <p><strong>Precio:</strong> $${formatMoney(v.precio)}</p>
      <p><strong>Enganche:</strong> $${formatMoney(v.enganche)}</p>
      <p><strong>M√©todo:</strong> ${v.metodoPago || '-'}</p>
      <p><strong>Cobro/Transfer:</strong> ${v.tipoCobro || '-'}</p>
      <p><strong>Cobrador:</strong> ${cobr? cobr.nombre : '-'}</p>
      <p><strong>Pago semanal:</strong> ${v.pagoSemanal? '$'+formatMoney(v.pagoSemanal) : '-'}</p>
      <p><strong>Pago quincenal:</strong> ${v.pagoQuincenal? '$'+formatMoney(v.pagoQuincenal) : '-'}</p>
      <p><strong>Horario:</strong> ${v.horario || '-'}</p>
      <p><strong>Lugar cobro:</strong> ${v.lugarCobro || '-'}</p>
      <p><strong>Observaciones:</strong> ${v.observaciones || '-'}</p>
      <hr>
      <div id="qrcode"></div>
      <p style="text-align:center;font-size:0.9em">Gracias por su compra</p>
    </body></html>`;
  printWindow.document.write(docHtml); printWindow.document.close();
  printWindow.onload = function(){
    const qrData = JSON.stringify({ folio: padFolio(v.folio), cliente: v.nombre, total: formatMoney(v.precio), fecha: fechaNow.toISOString() });
    const qDiv = printWindow.document.getElementById('qrcode');
    // QR code lib is available in parent, create DOM QR inside printWindow
    new printWindow.QRCode(qDiv, { text: qrData, width: 140, height: 140 });
    setTimeout(()=>{ printWindow.focus(); printWindow.print(); }, 500);
  };
}
function printTicketById(id){ const v = ventas.find(x=>x.id===id); if(v) printTicket(v); }

/* ============================
   RUTA: show clients and map using Leaflet
   ============================ */
let mapAll = null; let mapClientes = null; let mapRuta = null;
let markersAll = []; let markersCli = []; let markersRuta = [];

function initMaps(){
  try{
    mapAll = L.map('mapAll', { center:[20.6597,-103.3496], zoom:5 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapAll);
    mapClientes = L.map('mapClientes', { center:[20.6597,-103.3496], zoom:5 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapClientes);
    mapRuta = L.map('mapRuta', { center:[20.6597,-103.3496], zoom:5 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapRuta);
    refreshMaps();
  }catch(e){ console.warn('Leaflet init error', e); }
}

function refreshMaps(){
  markersAll.forEach(m=>m.remove()); markersAll=[]; markersCli.forEach(m=>m.remove()); markersCli=[]; markersRuta.forEach(m=>m.remove()); markersRuta=[];
  let boundsAll = [];
  clientes.forEach(c=>{
    if(c.lat && c.lng){
      const m = L.marker([c.lat,c.lng]).addTo(mapAll).bindPopup(`<strong>${c.nombre}</strong><br>Saldo: $${formatMoney(c.saldo)}`);
      markersAll.push(m); boundsAll.push([c.lat,c.lng]);
      const mc = L.marker([c.lat,c.lng]).addTo(mapClientes).bindPopup(`<strong>${c.nombre}</strong><br>Tel: ${c.telefono||'-'}`);
      markersCli.push(mc);
    }
  });
  if(boundsAll.length){ try{ mapAll.fitBounds(boundsAll, { padding:[40,40] }); mapClientes.fitBounds(boundsAll, { padding:[40,40] }); }catch(e){} }
}

function showRouteForCobrador(){
  const cobId = document.getElementById('rutaCobrador').value;
  const filtro = document.getElementById('rutaFiltroSaldo').value;
  const cont = document.getElementById('listaRuta'); cont.innerHTML='';
  let list = clientes.slice();
  if(filtro==='pendiente') list = list.filter(c=> Number(c.saldo)>0 );
  if(filtro==='pagados') list = list.filter(c=> Number(c.saldo)<=0 );
  list.forEach(c=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><strong>${c.nombre}</strong><div class="muted">Saldo: $${formatMoney(c.saldo)}</div></div>`;
    const actions = document.createElement('div');
    const btnVer = document.createElement('button'); btnVer.className='small'; btnVer.textContent='Ver ubic';
    btnVer.addEventListener('click', ()=> { if(c.ubicacion) window.open(c.ubicacion,'_blank'); else toast('Sin ubicaci√≥n'); });
    const inpConcept = document.createElement('input'); inpConcept.placeholder='Concepto'; inpConcept.style.width='140px';
    const inpAbono = document.createElement('input'); inpAbono.type='number'; inpAbono.placeholder='Abono'; inpAbono.style.width='90px';
    const btnAp = document.createElement('button'); btnAp.className='small'; btnAp.textContent='Aplicar';
    btnAp.addEventListener('click', ()=>{
      const concepto = inpConcept.value.trim(); const ab = Number(inpAbono.value||0);
      if(!concepto || ab<=0){ toast('Concepto y abono v√°lidos'); return; }
      applyAbono(c, cobId, concepto, ab);
    });
    actions.appendChild(btnVer); actions.appendChild(inpConcept); actions.appendChild(inpAbono); actions.appendChild(btnAp);
    div.appendChild(actions); cont.appendChild(div);
  });
  // update mapRuta
  markersRuta.forEach(m=>m.remove()); markersRuta=[];
  let bounds=[];
  list.forEach(c=>{
    if(c.lat && c.lng){
      const m = L.marker([c.lat,c.lng]).addTo(mapRuta).bindPopup(`<strong>${c.nombre}</strong><br>Saldo: $${formatMoney(c.saldo)}`);
      markersRuta.push(m); bounds.push([c.lat,c.lng]);
    }
  });
  if(bounds.length) try{ mapRuta.fitBounds(bounds, { padding:[40,40] }); }catch(e){}
}

/* apply abono */
function applyAbono(clienteObj, cobradorId, concepto, abonoVal){
  const idx = clientes.findIndex(x=>x.id === clienteObj.id);
  if(idx === -1) { toast('Cliente no encontrado'); return; }
  const anterior = Number(clientes[idx].saldo || 0);
  let nuevo = anterior - Number(abonoVal); if(nuevo < 0) nuevo = 0;
  clientes[idx].saldo = nuevo;
  abonos.push({ id:'a_'+Date.now(), cliente: clienteObj.nombre, cobrador: cobradorId, concepto, abono: Number(abonoVal), fecha: new Date().toISOString() });
  persistAll(); renderClientes(); showRouteForCobrador(); renderReportResults(); toast('Abono registrado');
  const ticket = { cliente: clienteObj.nombre, cobrador: (cobradores.find(x=>x.id===cobradorId)||{}).nombre || '', concepto, anterior, abono: Number(abonoVal), restante: nuevo };
  printReceipt(ticket);
}
function printReceipt(t){
  const w = window.open('','_blank','width=420,height=620');
  const html = `
    <html><head><title>Comprobante</title></head><body style="font-family:Segoe UI;padding:16px">
      <h2 style="text-align:center">Comprobante de Pago</h2><hr>
      <p><strong>Cliente:</strong> ${t.cliente}</p>
      <p><strong>Cobrador:</strong> ${t.cobrador}</p>
      <p><strong>Concepto:</strong> ${t.concepto}</p>
      <p><strong>Saldo anterior:</strong> $${formatMoney(t.anterior)}</p>
      <p><strong>Abono:</strong> $${formatMoney(t.abono)}</p>
      <p><strong>Saldo restante:</strong> $${formatMoney(t.restante)}</p>
      <hr><p style="text-align:center">Este comprobante sirve como constancia de pago</p>
    </body></html>`;
  w.document.write(html); w.document.close(); w.print();
}

/* ============================
   REPORTES: filter/export
   ============================ */
document.getElementById('btnRunReport').addEventListener('click', renderReportResults);
document.getElementById('btnExportCSV').addEventListener('click', exportReportCSV);
document.getElementById('btnExportPDF').addEventListener('click', exportReportPDF);

function renderReportResults(){
  const cli = document.getElementById('reportCliente').value;
  const cob = document.getElementById('reportCobrador').value;
  const desde = document.getElementById('reportDesde').value;
  const hasta = document.getElementById('reportHasta').value;
  const cont = document.getElementById('reportResults'); cont.innerHTML='';
  let list = abonos.slice();
  if(cli) list = list.filter(a=> a.cliente === (clientes.find(c=>c.id===cli)||{}).nombre );
  if(cob) list = list.filter(a=> a.cobrador === cob);
  if(desde) list = list.filter(a=> new Date(a.fecha) >= new Date(desde + 'T00:00:00'));
  if(hasta) list = list.filter(a=> new Date(a.fecha) <= new Date(hasta + 'T23:59:59'));
  if(list.length===0){ cont.innerHTML = '<div class="muted">No hay registros</div>'; return; }
  list.forEach(a=>{
    const d = document.createElement('div'); d.className='item';
    const cobName = (cobradores.find(x=>x.id===a.cobrador)||{}).nombre || a.cobrador;
    d.textContent = `${new Date(a.fecha).toLocaleString()} ‚Äî ${a.cliente} | ${a.concepto} | $${formatMoney(a.abono)} ‚Ä¢ ${cobName}`;
    cont.appendChild(d);
  });
}

function exportReportCSV(){
  const rows = [['Fecha','Cliente','Concepto','Abono','Cobrador']];
  abonos.forEach(a=>{
    const cobName = (cobradores.find(x=>x.id===a.cobrador)||{}).nombre || a.cobrador;
    rows.push([ new Date(a.fecha).toLocaleString(), a.cliente, a.concepto, formatMoney(a.abono), cobName ]);
  });
  const csv = rows.map(r => r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'report_abonos.csv'; a.click();
  URL.revokeObjectURL(url);
}

async function exportReportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12); doc.text('Reporte de Abonos', 14, 20);
  let y = 30;
  abonos.slice().forEach(a=>{
    const cobName = (cobradores.find(x=>x.id===a.cobrador)||{}).nombre || a.cobrador;
    const line = `${new Date(a.fecha).toLocaleString()} ‚Äî ${a.cliente} ‚Äî ${a.concepto} ‚Äî $${formatMoney(a.abono)} ‚Äî ${cobName}`;
    doc.text(line, 14, y);
    y+=6; if(y>270){ doc.addPage(); y=20; }
  });
  doc.save('reporte_abonos.pdf');
}

/* ============================
   INIT: events, maps, render
   ============================ */
function initRole(){
  if(!currentRole){ openRoleModal(); return; }
  document.getElementById('currentRole').textContent = currentRole;
  if(currentRole === 'Cobrador'){
    ['navClientes','navCobradores','navReportes','navConfig'].forEach(id=>document.getElementById(id).style.display='none');
  } else {
    ['navClients','navClientes','navCobradores','navReportes','navConfig'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='block'; });
  }
}

document.getElementById('btnLogout').addEventListener('click', ()=>{ if(confirm('Cerrar sesi√≥n?')){ localStorage.removeItem(LS.ROLE); currentRole=null; openRoleModal(); } });
document.getElementById('toggleTheme').addEventListener('click', ()=> setTheme(appEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark') );
document.getElementById('toggleThemeConfig').addEventListener('click', ()=> setTheme(appEl.getAttribute('data-theme') === 'dark' ? 'light' : 'dark') );

document.getElementById('openQuickAdd').addEventListener('click', ()=> { document.getElementById('navVentas').click(); });

document.getElementById('rutaCobrador').addEventListener('change', showRouteForCobrador);
document.getElementById('rutaFiltroSaldo').addEventListener('change', showRouteForCobrador);

document.getElementById('btnVerTodosMapa').addEventListener('click', ()=>{ document.getElementById('navClientes').click(); setTimeout(()=>{ refreshMaps(); }, 300); });

/* initial render */
refreshSelectors(); renderClientes(); renderCobradores(); renderVentasList(); renderReportResults();
setTimeout(()=>{ try{ initMaps(); }catch(e){} }, 400);
initRole();
if(!currentRole) openRoleModal();

</script>
</body>
</html>

