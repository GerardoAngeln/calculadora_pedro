<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infocell Victoria - Sistema de Control</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.18.0/firebase-database-compat.js"></script>

    <style>
        :root { --azul: #3498db; --verde: #27ae60; --rojo: #e74c3c; --negro: #000000; --gris: #f4f6f8; --dark: #2c3e50; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--gris); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--negro); color: white; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; }
        .logo-container { text-align: center; margin-bottom: 15px; min-height: 60px; }
        .logo-container img { max-width: 100%; max-height: 80px; object-fit: contain; }
        .sidebar .empresa-nombre { color: var(--azul); font-weight: bold; text-align: center; margin-bottom: 25px; font-size: 18px; }
        .sidebar button { width: 100%; padding: 12px; margin-bottom: 10px; border: none; border-radius: 10px; background: #1a1a1a; color: white; cursor: pointer; text-align: left; transition: 0.3s; }
        .sidebar button:hover { background: var(--azul); }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; padding: 10px; flex-direction: row; align-items: center; border-bottom: 2px solid var(--azul); }
            .sidebar .empresa-nombre, .logo-container { display: none; }
            .sidebar button { width: auto; margin: 0; padding: 10px 15px; }
        }

        /* CONTENIDO */
        .main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .card { background: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 5px solid var(--azul); }
        .card-admin { max-width: 1100px; border-top-color: var(--dark); }

        .reloj { font-size: 55px; text-align: center; font-weight: bold; color: var(--dark); margin-bottom: 5px; }
        .fecha-txt { text-align: center; color: #7f8c8d; margin-bottom: 25px; font-size: 14px; }
        
        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #dfe6e9; font-size: 16px; }
        .btn-main { width: 100%; padding: 16px; background: var(--verde); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }
        
        .table-area { width: 100%; overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: var(--dark); color: white; padding: 12px; font-size: 13px; text-align: center; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; color: #333; }

        .modulo { display: none; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 380px; text-align: center; }
        
        .resumen-nomina { background: #ebf5fb; padding: 15px; border-radius: 12px; margin-top: 15px; border-left: 5px solid var(--azul); display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-container" id="logoApp"></div>
        <div class="empresa-nombre" id="nombreApp">INFOCELL VICTORIA</div>
        <button onclick="navegar('inicio')">üè† Inicio</button>
        <button onclick="mostrarLogin()">üîë Administrador</button>
    </div>

    <div class="main">
        <div id="view-inicio" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="card">
                <div class="reloj" id="txtReloj">00:00:00</div>
                <div class="fecha-txt" id="txtFecha">Cargando...</div>
                <input type="password" id="inputPin" placeholder="Introduce tu PIN" style="text-align: center; letter-spacing: 5px;">
                <button class="btn-main" onclick="procesarRegistro()">REGISTRAR ASISTENCIA</button>
            </div>
            <div class="card">
                <h3 style="margin-top:0; color: var(--dark);">Actividad de Hoy</h3>
                <div id="listaHoy"></div>
            </div>
        </div>

        <div id="view-admin" class="card card-admin modulo">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin:0;">Panel de Gesti√≥n</h2>
                <button onclick="navegar('inicio')" style="background:#bdc3c7; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Cerrar Sesi√≥n</button>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                <button onclick="tab('t-personal')" class="btn-main" style="width:auto; background:var(--dark);">üë• Personal</button>
                <button onclick="tab('t-reportes')" class="btn-main" style="width:auto; background:var(--dark);">üí∞ N√≥mina</button>
                <button onclick="tab('t-config')" class="btn-main" style="width:auto; background:var(--dark);">‚öôÔ∏è Config</button>
            </div>

            <div id="t-personal" class="subtab">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <input id="p-nom" placeholder="Nombre Completo">
                    <input id="p-tel" placeholder="Tel√©fono">
                    <input id="p-pin" placeholder="PIN">
                    <input id="p-sueldo" type="number" placeholder="$ Pago por Hora">
                    <button class="btn-main" onclick="guardarPersonal()">Guardar</button>
                </div>
                <div class="table-area">
                    <table>
                        <thead><tr><th>Folio</th><th>Nombre</th><th>PIN</th><th>$ Hora</th><th>Acciones</th></tr></thead>
                        <tbody id="bodyPersonal"></tbody>
                    </table>
                </div>
            </div>

            <div id="t-reportes" class="subtab" style="display:none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                    <select id="rep-empleado"></select>
                    <input type="date" id="rep-desde">
                    <input type="date" id="rep-hasta">
                    <button class="btn-main" onclick="generarReporte()">Calcular Reporte</button>
                </div>
                <div id="boxResumen" class="resumen-nomina">
                    <p id="resumenTexto" style="margin:0; font-size: 18px; font-weight: bold;"></p>
                </div>
                <div class="table-area">
                    <table>
                        <thead><tr><th>Folio</th><th>Fecha</th><th>Nombre</th><th>Entrada</th><th>Salida</th><th>Horas</th><th>Subtotal</th></tr></thead>
                        <tbody id="bodyReportes"></tbody>
                    </table>
                </div>
            </div>

            <div id="t-config" class="subtab" style="display:none;">
                <div style="max-width: 500px;">
                    <label>Nombre Comercial:</label>
                    <input id="cfg-nombre" placeholder="Ej: Infocell Victoria">
                    <label>Logo de Empresa:</label>
                    <input type="file" id="cfg-logo" accept="image/*">
                    <button class="btn-main" onclick="actualizarConfig()">Actualizar Empresa</button>
                    <hr style="margin: 30px 0; opacity: 0.2;">
                    <button class="btn-main" style="background:var(--rojo);" onclick="resetSistema()">üß® Formatear Base de Datos</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modalLogin">
        <div class="modal-content">
            <h3>Acceso Restringido</h3>
            <input type="password" id="adminPass" placeholder="Clave de Administrador">
            <button class="btn-main" onclick="validarAdmin()">Entrar</button>
            <p onclick="document.getElementById('modalLogin').style.display='none'" style="margin-top:15px; cursor:pointer; color:gray;">Cancelar</p>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDjW-pIe-v1GYLT-Vwzqm-eAug1fTmsVsQ",
            authDomain: "relojchecador-fd23f.firebaseapp.com",
            projectId: "relojchecador-fd23f",
            databaseURL: "https://relojchecador-fd23f-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let empleados = []; let registros = []; let editId = null;

        function moverReloj() {
            const d = new Date();
            document.getElementById('txtReloj').innerText = d.toLocaleTimeString('es-MX', {hour12:false});
            document.getElementById('txtFecha').innerText = d.toLocaleDateString('es-MX', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
        }
        setInterval(moverReloj, 1000);

        db.ref('config').on('value', s => {
            const c = s.val() || {nombre: "INFOCELL VICTORIA"};
            document.getElementById('nombreApp').innerText = c.nombre;
            document.getElementById('cfg-nombre').value = c.nombre;
            if(c.logo) document.getElementById('logoApp').innerHTML = `<img src="${c.logo}">`;
        });

        db.ref('empleados').on('value', s => {
            empleados = s.val() ? Object.values(s.val()) : [];
            const t = document.getElementById('bodyPersonal'); t.innerHTML = "";
            const sel = document.getElementById('rep-empleado'); sel.innerHTML = "<option value=''>-- Seleccionar Empleado --</option>";
            empleados.forEach(e => {
                sel.innerHTML += `<option value="${e.nombre}">${e.nombre}</option>`;
                t.innerHTML += `<tr><td>${e.clave}</td><td>${e.nombre}</td><td>${e.pin}</td><td>$${e.sueldo}</td>
                <td><button onclick="prepararEdit('${e.clave}')">‚úèÔ∏è</button> <button onclick="borrarEmp('${e.clave}')">üóëÔ∏è</button></td></tr>`;
            });
        });

        db.ref('checadas').on('value', s => {
            registros = s.val() ? Object.values(s.val()) : [];
            const hoy = new Date().toISOString().split('T')[0];
            const h = document.getElementById('listaHoy'); h.innerHTML = "";
            registros.filter(r => r.fecha === hoy).reverse().slice(0,5).forEach(r => {
                h.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <span><b>${r.nombre}</b></span><span style="color:var(--azul)">${r.hora} (${r.tipo})</span></div>`;
            });
        });

        function procesarRegistro() {
            const p = document.getElementById('inputPin').value;
            const emp = empleados.find(x => x.pin === p);
            if(!emp) return alert("PIN Incorrecto");
            const hoy = new Date().toISOString().split('T')[0];
            const tipo = registros.filter(r => r.clave === emp.clave && r.fecha === hoy).length % 2 === 0 ? "ENTRADA" : "SALIDA";
            const ticket = "C" + (registros.length + 1).toString().padStart(4, '0');
            db.ref('checadas').push().set({ ticket, clave: emp.clave, nombre: emp.nombre, fecha: hoy, hora: document.getElementById('txtReloj').innerText, tipo, ts: Date.now() });
            document.getElementById('inputPin').value = "";
            alert(`${tipo} REGISTRADA: ${emp.nombre}`);
        }

        function guardarPersonal() {
            const n = document.getElementById('p-nom').value, p = document.getElementById('p-pin').value, s = document.getElementById('p-sueldo').value;
            if(!n || !p || !s) return alert("Faltan datos");
            let clave = editId || "V" + (empleados.length + 1).toString().padStart(5, '0');
            db.ref('empleados/'+clave).set({clave, nombre: n, pin: p, sueldo: parseFloat(s), tel: document.getElementById('p-tel').value});
            editId = null; ["p-nom","p-pin","p-sueldo","p-tel"].forEach(i => document.getElementById(i).value = "");
        }

        function prepararEdit(c) {
            const e = empleados.find(x => x.clave === c); editId = c;
            document.getElementById('p-nom').value = e.nombre; document.getElementById('p-pin').value = e.pin; document.getElementById('p-sueldo').value = e.sueldo;
        }

        function generarReporte() {
            const f1 = document.getElementById('rep-desde').value, f2 = document.getElementById('rep-hasta').value, empN = document.getElementById('rep-empleado').value;
            if(!f1 || !f2) return alert("Selecciona el rango de fechas");
            const t = document.getElementById('bodyReportes'); t.innerHTML = "";
            let sumaFinal = 0; const agrupado = {};
            registros.filter(r => r.fecha >= f1 && r.fecha <= f2 && (!empN || r.nombre === empN)).forEach(r => {
                const id = r.clave + r.fecha;
                if(!agrupado[id]) agrupado[id] = {id: r.ticket, f: r.fecha, n: r.nombre, e: null, s: null, cl: r.clave};
                if(r.tipo === "ENTRADA") agrupado[id].e = r.hora; else agrupado[id].s = r.hora;
            });
            Object.values(agrupado).forEach(v => {
                let hrs = 0, cash = 0;
                if(v.e && v.s) {
                    const diff = (new Date("2000/01/01 " + v.s) - new Date("2000/01/01 " + v.e)) / 3600000;
                    hrs = diff > 0 ? diff : 0;
                    const info = empleados.find(x => x.clave === v.cl);
                    cash = hrs * (info ? info.sueldo : 0);
                }
                sumaFinal += cash;
                t.innerHTML += `<tr><td>${v.id}</td><td>${v.f}</td><td>${v.n}</td><td>${v.e || '--'}</td><td>${v.s || '--'}</td><td>${hrs.toFixed(2)}</td><td>$${cash.toFixed(2)}</td></tr>`;
            });
            document.getElementById('boxResumen').style.display = "block";
            document.getElementById('resumenTexto').innerText = "Total acumulado en periodo: $" + sumaFinal.toFixed(2);
        }

        function tab(id) { document.querySelectorAll('.subtab').forEach(x => x.style.display='none'); document.getElementById(id).style.display='block'; }
        function mostrarLogin() { document.getElementById('modalLogin').style.display='flex'; }
        function validarAdmin() { if(document.getElementById('adminPass').value === "1010") { navegar('admin'); document.getElementById('modalLogin').style.display='none'; } else alert("Error"); }
        function navegar(p) { document.getElementById('view-inicio').style.display = p === 'inicio' ? 'flex' : 'none'; document.getElementById('view-admin').style.display = p === 'admin' ? 'block' : 'none'; }
        function borrarEmp(c) { if(confirm("¬øEliminar empleado?")) db.ref('empleados/'+c).remove(); }
        function actualizarConfig() {
            const n = document.getElementById('cfg-nombre').value, f = document.getElementById('cfg-logo').files[0];
            const up = (l = "") => db.ref('config').update({nombre: n, logo: l}).then(() => alert("Empresa Actualizada"));
            if(f) { const r = new FileReader(); r.onload = e => up(e.target.result); r.readAsDataURL(f); } else up();
        }
        function resetSistema() { if(confirm("¬°ATENCI√ìN! Se borrar√° toda la informaci√≥n. ¬øContinuar?")) db.ref('/').remove().then(() => location.reload()); }
    </script>
</body>
</html>
