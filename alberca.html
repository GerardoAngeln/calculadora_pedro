
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Palapas & Albercas</title>

<style>
body{margin:0;font-family:system-ui,sans-serif;background:#f2f4f7}
header{background:#0d9488;color:white;padding:22px;text-align:center}
.container{padding:16px}
.card{background:white;border-radius:14px;padding:14px;box-shadow:0 3px 8px rgba(0,0,0,.08);margin-bottom:16px}
.btn{width:100%;padding:14px;border:none;border-radius:14px;background:#0d9488;color:white;font-size:16px;font-weight:600;margin-top:10px}
.btn.sec{background:#0f766e}
input,select{width:100%;padding:12px;margin-top:10px;border-radius:10px;border:1px solid #d1d5db}

.compact{padding:12px}
.date-row{display:flex;align-items:center;gap:8px}
.status-row{display:flex;gap:8px;margin:8px 0}
.badge{
  flex:1;text-align:center;padding:8px;
  border-radius:8px;font-size:13px;font-weight:600
}
.badge.libre{background:#dcfce7;color:#166534}
.badge.ocupado{background:#fee2e2;color:#991b1b}

.place{padding:12px;border-radius:10px;margin-top:8px;font-size:14px}
.libre{background:#dcfce7}
.parcial{background:#fef3c7}
.ocupado{background:#fee2e2}
.alerta{background:#fecaca}

.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{padding:10px;text-align:center;border-radius:8px;font-size:13px}
.small{font-size:13px}
</style>
</head>

<body>

<header>
  <h1>ğŸ–ï¸ Palapas & Albercas</h1>
  <p>Agenda Â· AdministraciÃ³n Â· Abonos</p>
</header>

<div class="container">
  <button class="btn sec" onclick="mostrarAdmin()">ğŸ“Š AdministraciÃ³n</button>
</div>

<!-- ================= OPERACIÃ“N ================= -->
<div class="container" id="operacion">

  <!-- PANEL DE FECHA COMPACTO -->
  <div class="card compact">
    <div class="date-row">
      <span>ğŸ“…</span>
      <input type="date" id="fecha" onchange="revisarFecha()">
    </div>

    <div class="status-row">
      <div id="cv" class="badge libre">CAMINO VIEJO</div>
      <div id="art" class="badge libre">ART-YAD</div>
    </div>

    <button class="btn" id="btnRentar" onclick="mostrarFormulario()">Registrar renta</button>
  </div>

  <!-- FORMULARIO -->
  <div class="card" id="formulario" style="display:none">
    <strong>ğŸ“ Datos del cliente</strong>

    <input id="cliente" placeholder="Nombre del cliente">
    <input id="telefono" placeholder="TelÃ©fono WhatsApp (10 dÃ­gitos)" maxlength="10">
    <select id="espacio"></select>
    <input id="total" type="number" placeholder="Total $">
    <input id="abonadoInicial" type="number" placeholder="Abono inicial $ (opcional)">

    <button class="btn" onclick="guardarRenta()">Guardar y enviar WhatsApp</button>
  </div>

</div>

<!-- ================= ADMIN ================= -->
<div class="container" id="admin" style="display:none">

  <div class="card">
    <strong>ğŸ”” Alertas</strong>
    <div id="alertas" class="small"></div>
  </div>

  <div class="card">
    <strong>ğŸ“… Calendario mensual</strong>
    <div id="calendario" class="grid"></div>
  </div>

  <div class="card">
    <strong>ğŸ“‹ Rentas registradas</strong>
    <div id="listaRentas"></div>
  </div>

  <button class="btn" onclick="cerrarAdmin()">â¬…ï¸ Volver</button>
</div>

<script>
function obtenerRentas(){
  return JSON.parse(localStorage.getItem("rentas")) || [];
}
function guardarRentas(r){ localStorage.setItem("rentas",JSON.stringify(r)); }

function mostrarFormulario(){
  formulario.style.display="block";
}

/* ===== VALIDACIÃ“N HISTÃ“RICA ===== */
function revisarFecha(){
  const f = fecha.value;
  if(!f) return;

  const rentas = obtenerRentas();
  let cvO=false, artO=false;

  rentas.forEach(r=>{
    if(r.fecha===f){
      if(r.espacio==="CAMINO VIEJO") cvO=true;
      if(r.espacio==="ART-YAD") artO=true;
    }
  });

  cv.className=`badge ${cvO?'ocupado':'libre'}`;
  art.className=`badge ${artO?'ocupado':'libre'}`;

  espacio.innerHTML='<option value="">Selecciona el espacio</option>';
  if(!cvO) espacio.innerHTML+='<option value="CAMINO VIEJO">CAMINO VIEJO</option>';
  if(!artO) espacio.innerHTML+='<option value="ART-YAD">ART-YAD</option>';

  btnRentar.disabled = cvO && artO;
  btnRentar.textContent = btnRentar.disabled ? "Fecha no disponible" : "Registrar renta";
}

/* ===== GUARDAR RENTA ===== */
function guardarRenta(){
  const renta={
    fecha:fecha.value,
    cliente:cliente.value,
    telefono:telefono.value,
    espacio:espacio.value,
    total:Number(total.value),
    abonado:Number(abonadoInicial.value||0)
  };

  if(!renta.fecha||!renta.cliente||!renta.telefono||!renta.espacio||!renta.total){
    alert("Completa todos los campos");
    return;
  }

  const rentas=obtenerRentas();
  rentas.push(renta);
  guardarRentas(rentas);

  enviarWhats(
`ğŸ–ï¸ COMPROBANTE DE RENTA
Espacio: ${renta.espacio}
Cliente: ${renta.cliente}
Fecha: ${renta.fecha}

Total: $${renta.total}
Abonado: $${renta.abonado}
Saldo: $${renta.total-renta.abonado}`,
renta.telefono);
}

function enviarWhats(msg,tel){
  window.open(`https://wa.me/52${tel}?text=${encodeURIComponent(msg)}`,"_blank");
}

/* ===== ADMIN ===== */
function mostrarAdmin(){
  operacion.style.display="none";
  admin.style.display="block";
  cargarAdmin();
}
function cerrarAdmin(){
  admin.style.display="none";
  operacion.style.display="block";
}

function cargarAdmin(){
  const rentas=obtenerRentas();
  listaRentas.innerHTML="";
  calendario.innerHTML="";
  alertas.innerHTML="";

  const hoy=new Date();
  const dias={};

  rentas.forEach((r,i)=>{
    const saldo=r.total-r.abonado;
    const d=new Date(r.fecha);
    const diff=Math.ceil((d-hoy)/(1000*60*60*24));

    let estado="LIQUIDADO";
    if(saldo>0 && diff<=1){
      estado="PENDIENTE DE LIQUIDAR";
      alertas.innerHTML+=`ğŸ”´ ${r.cliente} (${r.fecha})<br>`;
    }else if(saldo>0){
      estado="SEPARADO";
    }

    dias[r.fecha]=(dias[r.fecha]||0)+1;

    listaRentas.innerHTML+=`
      <div class="place ${estado==="LIQUIDADO"?'libre':estado==="SEPARADO"?'parcial':'alerta'}">
        ğŸ“… ${r.fecha}<br>
        ğŸ–ï¸ ${r.espacio}<br>
        ğŸ‘¤ ${r.cliente}<br>
        ğŸ’° Total: $${r.total}<br>
        ğŸ’µ Abonado: $${r.abonado}<br>
        ğŸ’³ Saldo: $${saldo}<br>
        ğŸ”” Estado: <strong>${estado}</strong>
        ${saldo>0?`<button class="btn small" onclick="abonar(${i})">â• Abonar</button>`:""}
      </div>`;
  });

  const d=new Date();
  const y=d.getFullYear(), m=d.getMonth();
  const ult=new Date(y,m+1,0).getDate();

  for(let i=1;i<=ult;i++){
    const f=`${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    let c="libre";
    if(dias[f]===1) c="parcial";
    if(dias[f]>=2) c="ocupado";
    calendario.innerHTML+=`<div class="day ${c}">${i}</div>`;
  }
}

function abonar(i){
  const m=Number(prompt("Monto del abono:"));
  if(!m||m<=0) return;

  const rentas=obtenerRentas();
  rentas[i].abonado+=m;
  guardarRentas(rentas);

  enviarWhats(
`ğŸ’³ Abono registrado
Cliente: ${rentas[i].cliente}
Espacio: ${rentas[i].espacio}
Fecha: ${rentas[i].fecha}

Abono: $${m}
Total abonado: $${rentas[i].abonado}
Saldo: $${rentas[i].total-rentas[i].abonado}`,
rentas[i].telefono);

  cargarAdmin();
}
</script>

</body>
</html>
