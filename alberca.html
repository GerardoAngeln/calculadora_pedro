<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Palapas & Albercas</title>

<style>
body{margin:0;font-family:system-ui,sans-serif;background:#f2f4f7}
header{background:#0d9488;color:white;padding:22px;text-align:center}
.container{padding:16px}
.card{background:white;border-radius:14px;padding:14px;box-shadow:0 3px 8px rgba(0,0,0,.08);margin-bottom:16px}
.btn{width:100%;padding:14px;border:none;border-radius:14px;background:#0d9488;color:white;font-size:16px;font-weight:600;margin-top:10px}
.btn.sec{background:#0f766e}
.place{padding:12px;border-radius:10px;margin-top:8px;font-size:14px}
.libre{background:#dcfce7}
.ocupado{background:#fee2e2}
.parcial{background:#fef3c7}
.alerta{background:#fecaca}
input,select{width:100%;padding:12px;margin-top:10px;border-radius:10px;border:1px solid #d1d5db}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.day{padding:10px;text-align:center;border-radius:8px;font-size:13px}
</style>
</head>

<body>

<header>
  <h1>ğŸ–ï¸ Palapas & Albercas</h1>
  <p>Agenda, administraciÃ³n y seguimiento</p>
</header>

<div class="container">
  <button class="btn sec" onclick="mostrarAdmin()">ğŸ“Š AdministraciÃ³n</button>
</div>

<!-- ================= OPERACIÃ“N ================= -->
<div class="container" id="operacion">

  <div class="card">
    <strong>ğŸ“… Selecciona fecha</strong>
    <input type="date" id="fecha" onchange="revisarFecha()">

    <div id="cv" class="place libre">ğŸ–ï¸ CAMINO VIEJO <strong>DISPONIBLE</strong></div>
    <div id="art" class="place libre">ğŸ–ï¸ ART-YAD <strong>DISPONIBLE</strong></div>

    <button class="btn" id="btnRentar" onclick="mostrarFormulario()">Registrar renta</button>
  </div>

  <div class="card" id="formulario" style="display:none">
    <strong>ğŸ“ Datos del cliente</strong>

    <input id="cliente" placeholder="Nombre del cliente">
    <input id="telefono" placeholder="TelÃ©fono WhatsApp (10 dÃ­gitos)" maxlength="10">
    <select id="espacio"></select>
    <input id="total" type="number" placeholder="Total $">
    <input id="anticipo" type="number" placeholder="Anticipo $ (opcional)">

    <button class="btn" onclick="guardarYEnviar()">Enviar comprobante WhatsApp</button>
  </div>

</div>

<!-- ================= ADMIN ================= -->
<div class="container" id="admin" style="display:none">

  <div class="card">
    <strong>ğŸ”” Alertas</strong>
    <div id="alertas"></div>
  </div>

  <div class="card">
    <strong>ğŸ“… Calendario mensual</strong>
    <div id="calendario" class="grid"></div>
  </div>

  <div class="card">
    <strong>ğŸ“‹ Rentas registradas</strong>
    <div id="listaRentas"></div>
  </div>

  <button class="btn" onclick="cerrarAdmin()">â¬…ï¸ Volver</button>
</div>

<script>
function mostrarFormulario(){
  document.getElementById("formulario").style.display="block";
}

/* ===== VALIDACIÃ“N HISTÃ“RICA POR FECHA ===== */
function revisarFecha(){
  const fechaSeleccionada = fecha.value;
  if(!fechaSeleccionada) return;

  const rentas = JSON.parse(localStorage.getItem("rentas")) || [];

  let cvOcupada = false;
  let artOcupada = false;

  rentas.forEach(r=>{
    if(r.fecha === fechaSeleccionada){
      if(r.espacio === "CAMINO VIEJO") cvOcupada = true;
      if(r.espacio === "ART-YAD") artOcupada = true;
    }
  });

  cv.className = `place ${cvOcupada?'ocupado':'libre'}`;
  cv.innerHTML = `ğŸ–ï¸ CAMINO VIEJO <strong>${cvOcupada?'OCUPADA':'DISPONIBLE'}</strong>`;

  art.className = `place ${artOcupada?'ocupado':'libre'}`;
  art.innerHTML = `ğŸ–ï¸ ART-YAD <strong>${artOcupada?'OCUPADA':'DISPONIBLE'}</strong>`;

  espacio.innerHTML = `<option value="">Selecciona el espacio</option>`;
  if(!cvOcupada) espacio.innerHTML += `<option value="CAMINO VIEJO">CAMINO VIEJO</option>`;
  if(!artOcupada) espacio.innerHTML += `<option value="ART-YAD">ART-YAD</option>`;

  btnRentar.disabled = cvOcupada && artOcupada;
  btnRentar.textContent = btnRentar.disabled ? "Fecha no disponible" : "Registrar renta";
}

/* ===== GUARDAR Y WHATSAPP ===== */
function guardarYEnviar(){
  const r={
    fecha:fecha.value,
    cliente:cliente.value,
    telefono:telefono.value,
    espacio:espacio.value,
    total:Number(total.value),
    anticipo:Number(anticipo.value||0)
  };

  if(!r.fecha||!r.cliente||!r.telefono||!r.espacio||!r.total){
    alert("Completa todos los campos");
    return;
  }

  r.estado = r.anticipo < r.total ? "SEPARADO" : "LIQUIDADO";

  const rentas = JSON.parse(localStorage.getItem("rentas")) || [];
  rentas.push(r);
  localStorage.setItem("rentas",JSON.stringify(rentas));

  const msg=`ğŸ–ï¸ COMPROBANTE DE RENTA
Espacio: ${r.espacio}
Cliente: ${r.cliente}
Fecha: ${r.fecha}
Total: $${r.total}
Anticipo: $${r.anticipo}
Saldo: $${r.total-r.anticipo}`;

  window.open(`https://wa.me/52${r.telefono}?text=${encodeURIComponent(msg)}`,"_blank");
}

/* ===== ADMIN ===== */
function mostrarAdmin(){
  operacion.style.display="none";
  admin.style.display="block";
  cargarAdmin();
}

function cerrarAdmin(){
  admin.style.display="none";
  operacion.style.display="block";
}

function cargarAdmin(){
  const rentas = JSON.parse(localStorage.getItem("rentas")) || [];
  listaRentas.innerHTML="";
  calendario.innerHTML="";
  alertas.innerHTML="";

  const hoy = new Date();
  const dias = {};

  rentas.forEach(r=>{
    const d = new Date(r.fecha);
    const diff = Math.ceil((d-hoy)/(1000*60*60*24));

    if(diff<=1 && r.anticipo<r.total){
      alertas.innerHTML+=`ğŸ”´ Pendiente de liquidar: ${r.cliente} (${r.fecha})<br>`;
    }

    dias[r.fecha] = dias[r.fecha] ? dias[r.fecha]+1 : 1;

    listaRentas.innerHTML+=`
      <div class="place ${r.anticipo<r.total?'parcial':'libre'}">
        ğŸ“… ${r.fecha}<br>
        ğŸ–ï¸ ${r.espacio}<br>
        ğŸ‘¤ ${r.cliente}
      </div>`;
  });

  const hoyFecha=new Date();
  const y=hoyFecha.getFullYear();
  const m=hoyFecha.getMonth();
  const ultimo=new Date(y,m+1,0).getDate();

  for(let d=1;d<=ultimo;d++){
    const f=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    let cls="libre";
    if(dias[f]===1) cls="parcial";
    if(dias[f]>=2) cls="ocupado";
    calendario.innerHTML+=`<div class="day ${cls}">${d}</div>`;
  }
}
</script>

</body>
</html>
